#!/usr/bin/with-contenv bashio
# Enable strict mode
set -e
# shellcheck disable=SC1091


# Get App Version
App_version=$(bashio::app.version)

# Run App
cd /app
# Use fixed port 3000 for host_network mode (cannot be changed)
# This port must remain 3000 to avoid conflicts with other services
WEB_APP_PORT=3000
export WEB_APP_PORT


bashio::log.info "Using fixed port 3000 for webapp (required for host_network mode)"

# Kill any existing node processes that might be using the port
# This prevents EADDRINUSE errors when the service restarts
bashio::log.info "Checking for existing processes on port ${WEB_APP_PORT}..."

# Function to check if port is in use (only network connections, not file descriptors)
check_port() {
    local port=$1
    # Use ss or netstat to check for actual network listeners (TCP/UDP)
    # This avoids false positives from file descriptors
    if command -v ss >/dev/null 2>&1; then
        # Check for TCP listeners on the port
        ss -tuln | grep -q ":${port} " >/dev/null 2>&1
    elif command -v netstat >/dev/null 2>&1; then
        # Check for TCP listeners on the port
        netstat -tuln | grep -q ":${port} " >/dev/null 2>&1
    elif command -v lsof >/dev/null 2>&1; then
        # Only check for network connections, not all file descriptors
        lsof -i ":${port}" -sTCP:LISTEN >/dev/null 2>&1
    else
        # Fallback: check for node processes
        pgrep -f "node.*app.js" >/dev/null 2>&1
    fi
}

# Function to show what's using the port (only network listeners)
show_port_usage() {
    local port=$1
    bashio::log.info "Checking what's listening on port ${port}..."
    if command -v ss >/dev/null 2>&1; then
        local listeners=$(ss -tulnp | grep ":${port} " || true)
        if [ -n "$listeners" ]; then
            bashio::log.warning "Network listeners on port ${port}:"
            echo "$listeners" | while IFS= read -r line; do
                bashio::log.warning "  $line"
            done
        else
            bashio::log.info "No network listeners found on port ${port}"
        fi
    elif command -v netstat >/dev/null 2>&1; then
        local listeners=$(netstat -tulnp | grep ":${port} " || true)
        if [ -n "$listeners" ]; then
            bashio::log.warning "Network listeners on port ${port}:"
            echo "$listeners" | while IFS= read -r line; do
                bashio::log.warning "  $line"
            done
        else
            bashio::log.info "No network listeners found on port ${port}"
        fi
    elif command -v lsof >/dev/null 2>&1; then
        # Only show network listeners, not all file descriptors
        local listeners=$(lsof -i ":${port}" -sTCP:LISTEN 2>/dev/null || true)
        if [ -n "$listeners" ]; then
            bashio::log.warning "Network listeners on port ${port}:"
            echo "$listeners" | while IFS= read -r line; do
                bashio::log.warning "  $line"
            done
        else
            bashio::log.info "No network listeners found on port ${port}"
        fi
    fi
}

# Kill node processes first
if command -v pgrep >/dev/null 2>&1 && pgrep -f "node.*app.js" >/dev/null 2>&1; then
    bashio::log.warning "Found existing node app.js processes. Terminating them..."
    if command -v pkill >/dev/null 2>&1; then
        pkill -9 -f "node.*app.js" 2>/dev/null || true
    else
        # Fallback: use ps and kill
        ps aux | grep "[n]ode.*app.js" | awk '{print $2}' | xargs kill -9 2>/dev/null || true
    fi
    sleep 2
fi

# Check if port is in use (only network listeners)
if check_port "${WEB_APP_PORT}"; then
    show_port_usage "${WEB_APP_PORT}"

    # Try to kill processes using the port (only network listeners)
    bashio::log.warning "Attempting to free port ${WEB_APP_PORT}..."
    if command -v ss >/dev/null 2>&1; then
        ss -tulnp | grep ":${WEB_APP_PORT} " | grep -oP 'pid=\K[0-9]+' | xargs kill -9 2>/dev/null || true
    elif command -v netstat >/dev/null 2>&1; then
        netstat -tulnp | grep ":${WEB_APP_PORT} " | grep -oP '[0-9]+/[^ ]+' | cut -d'/' -f1 | xargs kill -9 2>/dev/null || true
    elif command -v lsof >/dev/null 2>&1; then
        # Only kill network listeners, not file descriptors
        lsof -ti ":${WEB_APP_PORT}" -sTCP:LISTEN | xargs kill -9 2>/dev/null || true
    elif command -v fuser >/dev/null 2>&1; then
        fuser -k "${WEB_APP_PORT}/tcp" 2>/dev/null || true
    fi
    sleep 2
fi

# Wait for port to be free (max 10 seconds)
max_wait=10
wait_count=0
while check_port "${WEB_APP_PORT}" && [ $wait_count -lt $max_wait ]; do
    bashio::log.warning "Port ${WEB_APP_PORT} is still in use, waiting... ($wait_count/$max_wait)"
    if [ $wait_count -eq 0 ]; then
        show_port_usage "${WEB_APP_PORT}"
    fi

    sleep 1
    wait_count=$((wait_count + 1))

    # Try to kill processes using the port again (only network listeners)
    if command -v ss >/dev/null 2>&1; then
        # Get PIDs of processes listening on the port
        ss -tulnp | grep ":${WEB_APP_PORT} " | grep -oP 'pid=\K[0-9]+' | xargs kill -9 2>/dev/null || true
    elif command -v netstat >/dev/null 2>&1; then
        # Get PIDs of processes listening on the port
        netstat -tulnp | grep ":${WEB_APP_PORT} " | grep -oP '[0-9]+/[^ ]+' | cut -d'/' -f1 | xargs kill -9 2>/dev/null || true
    elif command -v lsof >/dev/null 2>&1; then
        # Only kill network listeners, not file descriptors
        lsof -ti ":${WEB_APP_PORT}" -sTCP:LISTEN | xargs kill -9 2>/dev/null || true
    elif command -v fuser >/dev/null 2>&1; then
        fuser -k "${WEB_APP_PORT}/tcp" 2>/dev/null || true
    fi
done

if check_port "${WEB_APP_PORT}"; then
    bashio::log.error "Port ${WEB_APP_PORT} is still in use after ${max_wait} seconds!"
    show_port_usage "${WEB_APP_PORT}"
    bashio::log.error "Please check what process is using this port and stop it manually."
    bashio::log.error "You can use: lsof -i :${WEB_APP_PORT} or ss -tulnp | grep :${WEB_APP_PORT}"
    exit 1
fi

bashio::log.info "Port ${WEB_APP_PORT} is free, proceeding with startup..."

# With host_network: true, we don't use Ingress, so SUBFOLDER should not be set
# SUBFOLDER is only for Ingress mode, which doesn't work with host_network
# Unset SUBFOLDER to ensure the app serves from root path "/"
# unset SUBFOLDER
# bashio::log.info "Using host_network mode - serving from root path (no SUBFOLDER)"

# Ensure the app listens on all interfaces (0.0.0.0) not just localhost
# This is important when using host_network mode
# The netboot.xyz webapp uses PORT environment variable and listens on 0.0.0.0 by default
export PORT=${WEB_APP_PORT}

# Verify app.js exists
if [ ! -f /app/app.js ]; then
	bashio::log.error "app.js not found in /app directory!"
	bashio::log.error "The webapp may not have been installed correctly."
	exit 1
fi

bashio::log.info "Starting webapp on port ${PORT} (listening on all interfaces)..."
bashio::log.info "Environment variables:"
bashio::log.info "  PORT=${PORT}"
bashio::log.info "  SUBFOLDER=${SUBFOLDER:-(not set)}"
bashio::log.info "Web UI should be accessible at: http://<your-home-assistant-ip>:3000"
bashio::log.info "Note: Using host_network mode - port 3000 is directly accessible (no port mapping)."

# Use exec to replace the shell process with node
# This ensures proper signal handling and process management
# The app should listen on 0.0.0.0 by default, but we ensure PORT is set
bashio::log.info "Executing: node app.js"
exec /usr/bin/node app.js
