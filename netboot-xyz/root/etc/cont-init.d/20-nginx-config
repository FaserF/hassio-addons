#!/usr/bin/with-contenv bash
if [ -f /run/ABORT_STARTUP ]; then exit 0; fi

# make our folders
mkdir -p \
  /assets \
  /config/{nginx/site-confs,log/nginx} \
  /run \
  /var/lib/nginx/tmp/client_body \
  /var/tmp/nginx

# copy config files
[[ ! -f /config/nginx/nginx.conf ]] && \
  cp /defaults/nginx.conf /config/nginx/nginx.conf
[[ ! -f /config/nginx/site-confs/default ]] && \
  cp /defaults/default /config/nginx/site-confs/default

# Check if the default nginx config listens on port 85 (to avoid conflict with webapp on 3000)
# If it doesn't (or if it's the old default listening on 80/default), replace it
if ! grep -q "listen 85" /config/nginx/site-confs/default; then
    bashio::log.warning "Default nginx config does not listen on port 85. Updating to prevent conflict..."
    mv /config/nginx/site-confs/default /config/nginx/site-confs/default.bak
    cp /defaults/default /config/nginx/site-confs/default
fi

# Ownership
chown -R abc:abc /assets
chown -R abc:abc /config