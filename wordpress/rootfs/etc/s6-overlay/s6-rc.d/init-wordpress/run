#!/usr/bin/with-contenv bashio
# shellcheck shell=bash

bashio::log.info "Initialize Wordpress..."

# Configure database connection
if bashio::services.available "mysql"; then
    bashio::log.info "Configuring Wordpress to use the MySQL service..."
    DB_HOST=$(bashio::services "mysql" "host")
    DB_PORT=$(bashio::services "mysql" "port")
    DB_USER=$(bashio::services "mysql" "username")
    DB_PASS=$(bashio::services "mysql" "password")
    DB_NAME="wordpress"

    # Combine host and port for Wordpress config
    if bashio::var.has_value "${DB_PORT}"; then
        DB_HOST_CONFIG="${DB_HOST}:${DB_PORT}"
    else
        DB_HOST_CONFIG="${DB_HOST}"
        DB_PORT="3306"
    fi
else
    bashio::exit.nok "This add-on now requires the MariaDB add-on to be installed and available!"
fi

# Removed insecure password check as we now auto-generate it


# Ensure database exists and is accessible
bashio::log.info "Checking database connection..."

local h p u pass

h="$DB_HOST"
p="$DB_PORT"

    u="$DB_USER"
    pass="$DB_PASS"

    # Create temporary config file for secure authentication
    local temp_config
    temp_config=$(mktemp)
    cat > "$temp_config" <<EOF
[client]
password=$pass
EOF
    chmod 600 "$temp_config"

    # Wait for loop
    for i in {1..30}; do
        if mariadb-admin --defaults-extra-file="$temp_config" ping -h "$h" -P "$p" -u "$u" --silent; then
            break
        fi
        bashio::log.info "Waiting for database... $i/30"
        sleep 2
    done

    # Verify connection after loop
    if ! mariadb-admin --defaults-extra-file="$temp_config" ping -h "$h" -P "$p" -u "$u" --silent; then
        bashio::log.error "Could not connect to database after retries!"
        rm -f "$temp_config"
        exit 1
    fi

    # Create DB
    bashio::log.info "Ensuring database '$DB_NAME' exists..."
    if ! mariadb --defaults-extra-file="$temp_config" -h "$h" -P "$p" -u "$u" -e "USE \`$DB_NAME\`" 2>/dev/null; then
         bashio::log.info "Database '$DB_NAME' not found. Creating..."
         if ! mariadb --defaults-extra-file="$temp_config" -h "$h" -P "$p" -u "$u" -e "CREATE DATABASE IF NOT EXISTS \`$DB_NAME\`"; then
            bashio::log.error "Failed to create database '$DB_NAME'!"
            rm -f "$temp_config"
            exit 1
         fi
         bashio::log.info "Database created."
    fi

    # Cleanup
    rm -f "$temp_config"
fi

# Check if Wordpress is installed
if [ ! -d /var/www/wordpress/wp-admin ]; then
    bashio::log.info "Installing Wordpress..."
    if [ ! -d /usr/src/wordpress ]; then
        bashio::exit.nok "Source directory /usr/src/wordpress not found!"
    fi
    cp -r /usr/src/wordpress/. /var/www/wordpress || bashio::exit.nok "Failed to copy Wordpress files!"
    bashio::log.info "Wordpress installed!"
fi

# Configuration
if [ ! -f /var/www/wordpress/wp-config.php ]; then
    bashio::log.info "Creating configuration..."
    mv /var/www/wordpress/wp-config-sample.php /var/www/wordpress/wp-config.php || bashio::exit.nok "Failed to create wp-config.php!"

    # Database - use variables set during validation
    # Escape special characters for sed
    # We escape backslashes first, then the delimiter (|) and ampersands
    db_host_escaped=$(echo "${DB_HOST_CONFIG}" | sed 's/\\/\\\\/g' | sed 's/[|&]/\\&/g')
    db_name_escaped=$(echo "${DB_NAME}" | sed 's/\\/\\\\/g' | sed 's/[|&]/\\&/g')
    db_user_escaped=$(echo "${DB_USER}" | sed 's/\\/\\\\/g' | sed 's/[|&]/\\&/g')
    db_pass_escaped=$(echo "${DB_PASS}" | sed 's/\\/\\\\/g' | sed 's/[|&]/\\&/g')

    sed -i "s|database_name_here|${db_name_escaped}|" /var/www/wordpress/wp-config.php
    sed -i "s|username_here|${db_user_escaped}|" /var/www/wordpress/wp-config.php
    sed -i "s|password_here|${db_pass_escaped}|" /var/www/wordpress/wp-config.php
    sed -i "s|localhost|${db_host_escaped}|" /var/www/wordpress/wp-config.php

    # Salt
    bashio::log.info "Generating salts..."
    if ! curl -s https://api.wordpress.org/secret-key/1.1/salt/ > /tmp/wp-salts; then
         bashio::log.warning "Failed to fetch unique keys and salts from WordPress.org! Using defaults (potentially insecure)."
         rm -f /tmp/wp-salts
    else
        # Validate salt content
        if [ ! -s /tmp/wp-salts ] || ! grep -q "define('AUTH_KEY'" /tmp/wp-salts; then
            bashio::log.warning "Downloaded salt file is empty or invalid! Using defaults (potentially insecure)."
            rm -f /tmp/wp-salts
        else
            # Request successful and valid: Replace placeholder salts
            # Delete the default salt definitions and append new ones.
            sed -i "/define('AUTH_KEY'/,/define('NONCE_SALT'/d" /var/www/wordpress/wp-config.php
            cat /tmp/wp-salts >> /var/www/wordpress/wp-config.php
            rm -f /tmp/wp-salts
            bashio::log.info "Authentication keys and salts successfully updated."
        fi
    fi
fi

# Permissions
bashio::log.info "Fixing permissions..."
chown -R nginx:nginx /var/www/wordpress || bashio::exit.nok "Failed to set ownership for /var/www/wordpress"
find /var/www/wordpress -type d -exec chmod 755 {} \; || bashio::exit.nok "Failed to set directory permissions"
find /var/www/wordpress -type f -exec chmod 644 {} \; || bashio::exit.nok "Failed to set file permissions"
chmod 640 /var/www/wordpress/wp-config.php || bashio::exit.nok "Failed to set permissions for wp-config.php"

bashio::log.info "Wordpress initialized!"

# Check if Wordpress is already installed
if ! wp --allow-root --path=/var/www/wordpress core is-installed; then
    bashio::log.info "Wordpress not installed. Installing..."

    # Generate secure password
    ADMIN_PASS=$(openssl rand -base64 24)
    ADMIN_USER=$(bashio::config 'wordpress_admin_user')
    ADMIN_EMAIL=$(bashio::config 'wordpress_admin_email')
    TITLE=$(bashio::config 'wordpress_title')

    # Install Wordpress
    if wp core install \
        --allow-root \
        --path=/var/www/wordpress \
        --url="http://localhost" \
        --title="${TITLE}" \
        --admin_user="${ADMIN_USER}" \
        --admin_password="${ADMIN_PASS}" \
        --admin_email="${ADMIN_EMAIL}"; then

        bashio::log.info "Wordpress installed successfully!"
        bashio::log.warning "------------------------------------------------"
        bashio::log.warning "Wordpress Admin Password: ${ADMIN_PASS}"
        bashio::log.warning "PLEASE SAVE THIS PASSWORD NOW!"
        bashio::log.warning "This password will NOT be shown again."
        bashio::log.warning "------------------------------------------------"
    else
        bashio::log.error "Failed to install Wordpress!"
    fi
else
    bashio::log.info "Wordpress database already installed."
fi
