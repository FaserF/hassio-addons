#!/usr/bin/env bashio

# Generate password if not exists
if ! bashio::fs.file_exists "/data/planka_db_password"; then
    openssl rand -hex 32 > /data/planka_db_password
fi
PLANKA_DB_PASSWORD=$(cat /data/planka_db_password)
POSTGRES_PASSWORD=$(cat /data/postgres_password)

export PGPASSWORD="${POSTGRES_PASSWORD}"

# Wait for PostgreSQL to be ready
bashio::log.info "Waiting for PostgreSQL to be ready..."
until pg_isready -h localhost -U postgres; do
    sleep 1
done

# Create Planka database and user if they don't exist
bashio::log.info "Ensuring Planka database and user exist..."
psql -h localhost -U postgres -tc "SELECT 1 FROM pg_database WHERE datname = 'planka'" | grep -q 1 || \
    psql -h localhost -U postgres -c "CREATE DATABASE planka;"

# Check if user exists (role)
if [ "$(psql -h localhost -U postgres -v ON_ERROR_STOP=1 -tAc "SELECT 1 FROM pg_roles WHERE rolname = 'planka'")" != "1" ]; then
    psql -h localhost -U postgres -v ON_ERROR_STOP=1 -c "CREATE USER planka WITH PASSWORD '${PLANKA_DB_PASSWORD}';"
fi

<<<<<<< Updated upstream
psql -h localhost -U postgres -v ON_ERROR_STOP=1 -c "GRANT ALL PRIVILEGES ON DATABASE planka TO planka;"
# Grant schema privileges if needed (public schema usually open)
# Planka needs to create tables.
=======
psql -h localhost -U postgres -tc "SELECT 1 FROM pg_roles WHERE rolname = 'planka'" | grep -q 1 || \
    psql -h localhost -U postgres -c "CREATE USER planka WITH PASSWORD '${PLANKA_DB_PASSWORD}';"

psql -h localhost -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE planka TO planka;"

# PostgreSQL 15+ revoked default CREATE on public schema - grant it explicitly
psql -h localhost -U postgres -d planka -c "GRANT ALL ON SCHEMA public TO planka;"
psql -h localhost -U postgres -d planka -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO planka;"
psql -h localhost -U postgres -d planka -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO planka;"
psql -h localhost -U postgres -d planka -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO planka;"
psql -h localhost -U postgres -d planka -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO planka;"
>>>>>>> Stashed changes
