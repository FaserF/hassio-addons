#!/usr/bin/env bashio

# Generate password if not exists
if ! bashio::fs.file_exists "/data/planka_db_password"; then
    openssl rand -hex 32 > /data/planka_db_password
fi
PLANKA_DB_PASSWORD=$(cat /data/planka_db_password)
POSTGRES_PASSWORD=$(cat /data/postgres_password)

export PGPASSWORD="${POSTGRES_PASSWORD}"

# Wait for PostgreSQL to be ready
bashio::log.info "Waiting for PostgreSQL to be ready..."
until pg_isready -h localhost -U postgres; do
    sleep 1
done

# Database Reset Check (Two-Step)
if bashio::config.true 'reset_database'; then
	if ! bashio::config.true 'reset_database_confirm'; then
		bashio::log.error "Database reset requires both 'reset_database' and 'reset_database_confirm' to be enabled!"
		bashio::log.error "This is a DESTRUCTIVE operation that will DELETE ALL DATA!"
		bashio::log.error "Set 'reset_database_confirm: true' in your configuration to proceed."
		bashio::exit.nok "Database reset confirmation required"
	fi

	bashio::log.warning "=========================================="
	bashio::log.warning "   âš ï¸  DATABASE RESET ENABLED  âš ï¸"
	bashio::log.warning "=========================================="
	bashio::log.warning "ALL PLANKA DATA WILL BE PERMANENTLY DELETED!"
	bashio::log.warning "This includes:"
	bashio::log.warning "  - All boards and cards"
	bashio::log.warning "  - All users and projects"
	bashio::log.warning "  - All attachments and comments"
	bashio::log.warning "=========================================="

	# Create timestamped backup before deleting
	BACKUP_DIR="/data/backups"
	mkdir -p "$BACKUP_DIR"
	TIMESTAMP=$(date +%Y%m%d_%H%M%S)
	BACKUP_FILE="$BACKUP_DIR/planka_backup_${TIMESTAMP}.sql"

	bashio::log.info "Creating backup before database reset..."
	bashio::log.info "Backup location: $BACKUP_FILE"

	# Create backup using pg_dump
	if psql -h localhost -U postgres -lqt | cut -d \| -f 1 | grep -qw planka; then
		if pg_dump -h localhost -U postgres planka > "$BACKUP_FILE" 2>/dev/null; then
			bashio::log.info "Backup created successfully: $BACKUP_FILE"
		else
			bashio::log.warning "Backup failed, continuing with reset..."
		fi
	else
		bashio::log.info "Database does not exist yet, skipping backup..."
	fi

	# Wait 3 seconds to give user time to cancel
	bashio::log.warning "Starting reset in 3 seconds... (Stop add-on NOW to abort)"
	sleep 3

	bashio::log.info "Proceeding with database reset..."

	# Drop database if it exists
	psql -h localhost -U postgres -c "DROP DATABASE IF EXISTS planka;" || bashio::log.warning "Failed to drop database"

	# Remove admin created marker so it will be recreated
	rm -f /data/planka_admin_created

	bashio::log.info "=========================================="
	bashio::log.info "   âœ… DATABASE RESET COMPLETE"
	bashio::log.info "=========================================="
	bashio::log.info "Database has been dropped."
	bashio::log.info "It will be recreated on next step."
	bashio::log.warning "IMPORTANT: Disable 'reset_database' and 'reset_database_confirm' in the add-on settings!"
	bashio::log.warning "Otherwise, the database will be wiped again on next restart."
	bashio::log.info "=========================================="

	# Remove reset_database options
	bashio::addon.option 'reset_database'
	bashio::addon.option 'reset_database_confirm'
fi

# Create Planka database and user if they don't exist
bashio::log.info "Ensuring Planka database and user exist..."
psql -h localhost -U postgres -tc "SELECT 1 FROM pg_database WHERE datname = 'planka'" | grep -q 1 || \
    psql -h localhost -U postgres -c "CREATE DATABASE planka;"

# Check if user exists (role)
if [ "$(psql -h localhost -U postgres -v ON_ERROR_STOP=1 -tAc "SELECT 1 FROM pg_roles WHERE rolname = 'planka'")" != "1" ]; then
    psql -h localhost -U postgres -v ON_ERROR_STOP=1 -c "CREATE USER planka WITH PASSWORD '${PLANKA_DB_PASSWORD}';"
fi

psql -h localhost -U postgres -v ON_ERROR_STOP=1 -c "GRANT ALL PRIVILEGES ON DATABASE planka TO planka;"

# PostgreSQL 15+ revoked default CREATE on public schema - grant it explicitly
psql -h localhost -U postgres -d planka -c "GRANT ALL ON SCHEMA public TO planka;"
psql -h localhost -U postgres -d planka -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO planka;"
psql -h localhost -U postgres -d planka -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO planka;"
psql -h localhost -U postgres -d planka -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO planka;"
psql -h localhost -U postgres -d planka -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO planka;"

# Create default admin user on first start
if ! bashio::fs.file_exists "/data/planka_admin_created"; then
    bashio::log.info "First start detected - admin user will be created after Planka starts..."

    # Generate secure password
    ADMIN_PASSWORD=$(openssl rand -base64 24)
    echo -n "$ADMIN_PASSWORD" > /data/planka_admin_password
    chmod 600 /data/planka_admin_password

    # Store credentials for later (after Planka service is running)
    cat > /data/create_admin_user.sh << 'EOFSCRIPT'
#!/bin/bash
# Wait for Planka to be fully ready
sleep 10

# Read saved password
ADMIN_PASSWORD=$(cat /data/planka_admin_password)

# Check if Planka is responding
for i in {1..30}; do
    if curl -sf http://localhost:1337 > /dev/null; then
        break
    fi
    sleep 2
done

# Create admin user via Planka's registration endpoint
# Planka allows the first user to register without authentication
RESPONSE=$(curl -s -X POST http://localhost:1337/api/users \
  -H "Content-Type: application/json" \
  -d "{
    \"email\": \"admin@planka.local\",
    \"password\": \"$ADMIN_PASSWORD\",
    \"name\": \"Administrator\",
    \"username\": \"admin\"
  }")

if echo "$RESPONSE" | grep -q "id"; then
    # Mark as created
    touch /data/planka_admin_created

    # Display credentials prominently
    bashio::log.warning "=========================================="
    bashio::log.warning "   ğŸ” PLANKA ADMIN CREDENTIALS"
    bashio::log.warning "=========================================="
    bashio::log.warning "Username: admin"
    bashio::log.warning "Email: admin@planka.local"
    bashio::log.warning "Password: ${ADMIN_PASSWORD}"
    bashio::log.warning "=========================================="
    bashio::log.warning "âš ï¸  SAVE THIS PASSWORD NOW!"
    bashio::log.warning "It will not be shown again."
    bashio::log.warning "Password saved to: /addon_configs/c1e285b7_planka/planka_admin_password"
    bashio::log.warning "=========================================="
else
    bashio::log.error "Failed to create admin user. You may need to register manually."
    bashio::log.error "Response: $RESPONSE"
fi

# Cleanup
rm -f /data/create_admin_user.sh
EOFSCRIPT

    chmod +x /data/create_admin_user.sh

    # Run in background after this script completes
    nohup /data/create_admin_user.sh > /proc/1/fd/1 2>&1 &
fi
