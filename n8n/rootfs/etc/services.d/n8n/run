#!/usr/bin/with-contenv bashio
# ==============================================================================
# Home Assistant Add-on: N8n
# Runs N8n
# ==============================================================================

# <ADDON_BANNER_INJECTION>

# ============================================================================
# Addon Startup Banner - Auto-generated by CI
# ============================================================================
_show_startup_banner() {
    local VERSION
    if ! VERSION=$(bashio::addon.version 2>/dev/null); then
        VERSION="unknown"
    fi
    if [ -z "$VERSION" ]; then
        VERSION="unknown"
    fi
    local NAME="N8n"
    local SLUG="n8n"
    local UNSUPPORTED="false"
    local MAINTAINER="FaserF"
    local REPO="$MAINTAINER/hassio-addons"

    # Extract base version and commit from dev versions (1.2.3-dev+abc123)
    local BASE_VERSION="${VERSION%%-dev*}"
    local DEV_COMMIT=""
    if [[ "$VERSION" == *"+"* ]]; then
        DEV_COMMIT="${VERSION##*+}"
    fi

    # Status indicator
    if [ "$UNSUPPORTED" = "true" ]; then
        bashio::log.error "üö® STATUS: UNSUPPORTED"
        bashio::log.error "   This addon is no longer maintained!"
    elif [[ "$VERSION" == *"-dev"* ]]; then
        bashio::log.warning "üöß STATUS: DEVELOPMENT"
        bashio::log.warning "   This is a development build!"
    elif [[ "${BASE_VERSION%%.*}" =~ ^[0-9]+$ ]] && [ "${BASE_VERSION%%.*}" -lt 1 ] 2>/dev/null; then
        bashio::log.notice "üî¨ STATUS: BETA"
        bashio::log.notice "   This addon is in beta testing."
    else
        bashio::log.green "‚úÖ STATUS: STABLE"
    fi

    # Helper for semantic version comparison (Pure Bash)
    # Returns 0 if $1 > $2, 1 otherwise
    version_gt() {
        local v1="$1"
        local v2="$2"
        if [ "$v1" = "$v2" ]; then return 1; fi

        local IFS=.
        local i ver1 ver2
        read -ra ver1 <<< "$v1"
        read -ra ver2 <<< "$v2"

        # Pad with zeros
        for ((i=${#ver1[@]}; i<${#ver2[@]}; i++)); do ver1[i]=0; done
        for ((i=${#ver2[@]}; i<${#ver1[@]}; i++)); do ver2[i]=0; done

        for ((i=0; i<${#ver1[@]}; i++)); do
            # Handle non-numeric (e.g. dev versions) by treating as 0
            # Simple sanitization: remove anything not a digit using bash expansion
            local n1="${ver1[i]//[!0-9]/}"
            local n2="${ver2[i]//[!0-9]/}"

            # Fallback (rarely needed if using bash, but harmless to keep if desired,
            # though user suggestion implies we can rely on bash expansion)
            # We will use the bash expansion result directly.

            # Empty string -> 0
            [ -z "$n1" ] && n1=0
            [ -z "$n2" ] && n2=0

            if ((10#$n1 > 10#$n2)); then return 0; fi
            if ((10#$n1 < 10#$n2)); then return 1; fi
        done
        return 1
    }

    # ========================================================================
    # Smart Update Check
    # ========================================================================
    if command -v curl &>/dev/null; then
        local UPDATE_MSG=""

        # Ensure we don't fail on pipe errors
        local LATEST_STABLE=""

        # Get latest stable version from config.yaml
        if LATEST_STABLE=$(curl -s --max-time 10 "https://raw.githubusercontent.com/$REPO/master/$SLUG/config.yaml" 2>/dev/null | grep -E "^version:" | head -1 | sed 's/version:[[:space:]]*["'"'"']\?\([^"'"'"'+]*\).*/\1/' | sed 's/-dev.*//'); then
            : # Success
        else
            LATEST_STABLE=""
        fi

        if [ -n "$LATEST_STABLE" ]; then
            # For DEV versions: Check if there are newer commits for this addon
            if [[ "$VERSION" == *"-dev"* ]]; then
                if [ -n "$DEV_COMMIT" ]; then
                    # Get latest commit for this addon from GitHub
                    local LATEST_COMMIT=""
                    if LATEST_COMMIT=$(curl -s --max-time 10 "https://api.github.com/repos/$REPO/commits?path=$SLUG&per_page=1" 2>/dev/null | grep -o '"sha": "[^"]*"' | head -1 | cut -d'"' -f4 | head -c7); then
                         :
                    fi

                    if [ -n "$LATEST_COMMIT" ] && [ "$LATEST_COMMIT" != "$DEV_COMMIT" ]; then
                        UPDATE_MSG="‚¨ÜÔ∏è  DEV UPDATE: New commits available"
                        bashio::log.yellow "   Your commit: $DEV_COMMIT"
                        bashio::log.yellow "   Latest: $LATEST_COMMIT"
                    fi
                fi

                # Also check if a stable release is available
                if [ "$LATEST_STABLE" != "$BASE_VERSION" ]; then
                    # Compare versions
                    if version_gt "$LATEST_STABLE" "$BASE_VERSION" 2>/dev/null; then
                        UPDATE_MSG="‚¨ÜÔ∏è  STABLE RELEASE: $LATEST_STABLE available!"
                        bashio::log.yellow "   Consider upgrading to the stable release"
                    fi
                fi

            # For BETA versions (< 1.0.0): Check for newer beta OR stable
            elif [[ "${BASE_VERSION%%.*}" =~ ^[0-9]+$ ]] && [ "${BASE_VERSION%%.*}" -lt 1 ] 2>/dev/null; then
                if [ "$LATEST_STABLE" != "$BASE_VERSION" ]; then
                    # If stable is >= 1.0.0, it's definitely newer
                    local LATEST_MAJOR="${LATEST_STABLE%%.*}"
                    if [ "$LATEST_MAJOR" -ge 1 ] 2>/dev/null; then
                        UPDATE_MSG="‚¨ÜÔ∏è  STABLE RELEASE: $LATEST_STABLE available!"
                    elif version_gt "$LATEST_STABLE" "$BASE_VERSION" 2>/dev/null; then
                        UPDATE_MSG="‚¨ÜÔ∏è  UPDATE AVAILABLE: $LATEST_STABLE"
                    fi
                fi

            # For STABLE versions: Simple version comparison
            else
                if [ "$LATEST_STABLE" != "$BASE_VERSION" ]; then
                    if version_gt "$LATEST_STABLE" "$BASE_VERSION" 2>/dev/null; then
                        UPDATE_MSG="‚¨ÜÔ∏è  UPDATE AVAILABLE: $LATEST_STABLE"
                    fi
                fi
            fi
        fi

        if [ -n "$UPDATE_MSG" ]; then
            bashio::log.yellow "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            bashio::log.yellow "$UPDATE_MSG"
            bashio::log.yellow "   You are running: $VERSION"
            bashio::log.yellow "   Update via the Add-on Store"
            bashio::log.yellow "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        fi
    fi

    # Footer with links
    bashio::log.blue "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    bashio::log.info "üìù Issues: https://github.com/$REPO/issues"
    bashio::log.info "üíñ Maintained by: $MAINTAINER"
    bashio::log.blue "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    bashio::log.info ""
}

# Show banner on startup
if type bashio::log.blue &>/dev/null 2>&1; then
    _show_startup_banner
fi

# </ADDON_BANNER_INJECTION>




























# Ensure persistence directory exists
if ! bashio::fs.directory_exists "/data/n8n"; then
    bashio::log.info "Creating persistent storage directory..."
    mkdir -p -m 755 /data/n8n
    chown -R root:root /data/n8n
fi

# Export necessary environment variables
export N8N_USER_FOLDER="/data/n8n"

if bashio::config.has_value 'port'; then
    N8N_PORT=$(bashio::config 'port')
else
    N8N_PORT="5678"
fi
export N8N_PORT

if bashio::config.has_value 'listen_address'; then
    N8N_LISTEN_ADDRESS=$(bashio::config 'listen_address')
else
    N8N_LISTEN_ADDRESS="0.0.0.0"
fi
export N8N_LISTEN_ADDRESS

# SSL Configuration
if bashio::config.true 'ssl'; then
    bashio::log.info "SSL is enabled"
    export N8N_PROTOCOL="https"

    certfile=$(bashio::config 'certfile')
    keyfile=$(bashio::config 'keyfile')

    # Use defaults if not provided
    if bashio::var.is_empty "${certfile}"; then
        certfile="fullchain.pem"
    fi
    if bashio::var.is_empty "${keyfile}"; then
        keyfile="privkey.pem"
    fi

    export N8N_SSL_CERT="/ssl/${certfile}"
    export N8N_SSL_KEY="/ssl/${keyfile}"

    if ! bashio::fs.file_exists "${N8N_SSL_CERT}"; then
        bashio::log.error "Certificate file '${N8N_SSL_CERT}' not found!"
        bashio::exit.nok
    fi

    if ! bashio::fs.file_exists "${N8N_SSL_KEY}"; then
        bashio::log.error "Key file '${N8N_SSL_KEY}' not found!"
        bashio::exit.nok
    fi
else
    # Explicitly set http if ssl is false/missing to be safe
    export N8N_PROTOCOL="http"
fi

# Set Log Level from config (with fallback and mapping)
if bashio::config.has_value 'log_level'; then
    LOG_LEVEL="$(bashio::config 'log_level')"
    case "${LOG_LEVEL}" in
        trace|debug) N8N_LOG_LEVEL="debug" ;;
        info|notice) N8N_LOG_LEVEL="info" ;;
        warning)     N8N_LOG_LEVEL="warn" ;;
        error|fatal) N8N_LOG_LEVEL="error" ;;
        *)           N8N_LOG_LEVEL="info" ;;
    esac
    export N8N_LOG_LEVEL
else
    export N8N_LOG_LEVEL="info"
fi

bashio::log.info "Starting N8n..."
bashio::log.info "User folder: ${N8N_USER_FOLDER}"
bashio::log.info "Port: ${N8N_PORT}"
bashio::log.info "Log level: ${N8N_LOG_LEVEL}"

# Execute n8n
exec n8n start
