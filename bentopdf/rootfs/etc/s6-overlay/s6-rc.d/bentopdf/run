#!/command/with-contenv bashio
# shellcheck shell=bash

certfile=$(bashio::config 'certfile')
keyfile=$(bashio::config 'keyfile')
ssl=$(bashio::config 'ssl')
log_level=$(bashio::config 'log_level')

# Map Bashio log level to Nginx log level
case "${log_level}" in
trace | debug) nginx_log_level="debug" ;;
info | notice) nginx_log_level="info" ;;
warning | warn) nginx_log_level="warn" ;;
error) nginx_log_level="error" ;;
fatal) nginx_log_level="crit" ;;
*) nginx_log_level="warn" ;;
esac

# SSL Validation
if bashio::var.true "${ssl}"; then
    if ! bashio::config.has_value 'certfile'; then
        bashio::log.fatal "SSL enabled but 'certfile' option is empty!"
        bashio::exit.nok
    fi

    if ! bashio::config.has_value 'keyfile'; then
        bashio::log.fatal "SSL enabled but 'keyfile' option is empty!"
        bashio::exit.nok
    fi

    if ! bashio::fs.file_exists "/ssl/${certfile}"; then
        bashio::log.fatal "SSL enabled but certificate file '/ssl/${certfile}' not found!"
        bashio::exit.nok
    fi

    if ! bashio::fs.file_exists "/ssl/${keyfile}"; then
        bashio::log.fatal "SSL enabled but key file '/ssl/${keyfile}' not found!"
        bashio::exit.nok
    fi
fi

# Generate Nginx configuration
bashio::log.info "Generating Nginx configuration..."
cat > /etc/nginx/http.d/ingress.conf <<EOF || bashio::exit.nok "Failed to generate Nginx configuration"
server {
    listen 8035 $(if bashio::var.true "${ssl}"; then echo "ssl"; fi);
    root /var/www/bentopdf;
    index index.html;
    server_name _;
    client_max_body_size 0;

    $(if bashio::var.true "${ssl}"; then echo "
    ssl_certificate /ssl/${certfile};
    ssl_certificate_key /ssl/${keyfile};
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    "; fi)

    location / {
        try_files \$uri \$uri/ /index.html;
    }
}
EOF

bashio::log.info "Starting BentoPDF application..."

# Start Nginx with configured log level
# Replace any existing log level with configured level
sed -i "s|error_log /dev/stderr .*;|error_log /dev/stderr $nginx_log_level;|" /etc/nginx/nginx.conf || {
    bashio::log.error "Failed to update nginx log level"
    bashio::exit.nok
}
exec nginx -c /etc/nginx/nginx.conf
