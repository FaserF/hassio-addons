#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: Antigravity-Server
# Runs the NoVNC websocket proxy
# ==============================================================================

bashio::log.info "Starting NoVNC on port 6080..."

# Wait a moment for VNC to be ready
# Wait for VNC to be ready (max 10s)
for i in {1..20}; do
    if python3 -c "import socket; s = socket.socket(); s.connect(('127.0.0.1', 5901))" > /dev/null 2>&1; then
        bashio::log.info "VNC server is ready."
        break
    fi
    sleep 0.5
done

# Start NoVNC websocket proxy
exec /usr/bin/novnc_server \
    --listen 6080 \
    --vnc localhost:5901
