name: Orchestrator Unsupported Sync

# This workflow keeps the 'unsupported' branch populated with ONLY unsupported addons
# moving them to the root level.

on:
  push:
    branches:
      - master
    paths:
      - ".unsupported/**"
      - ".github/workflows/orchestrator-unsupported-sync.yaml"
      - ".scripts/prepare_unsupported_branch.py"
      - ".scripts/bump_version.py"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-unsupported:
    name: ðŸ’€ Sync Unsupported Branch
    runs-on: ubuntu-latest
    steps:
      - name: â¤µï¸ Checkout master
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ’€ Reset unsupported branch to master
        run: |
          echo "Resetting unsupported branch..."
          git checkout -B unsupported master

      - name: ðŸ§¹ Clean and Rearrange
        run: |
          echo "Removing supported addons..."
          # Delete everything that isn't .unsupported, .github, .scripts, or repository.json/files
          # Easier strategy: Move .unsupported contents to temp, clear, restore.

          mkdir ../temp_unsupported
          cp -r .unsupported/* ../temp_unsupported/ || echo "No unsupported addons found"

          # Remove all directories in current root except .github and .scripts and .git
          find . -maxdepth 1 -type d \
            -not -name "." \
            -not -name ".git" \
            -not -name ".github" \
            -not -name ".scripts" \
            -exec rm -rf {} +

          # Remove all files in root except needed
          find . -maxdepth 1 -type f \
            -not -name ".gitignore" \
            -not -name "repository.json" \
            -not -name "LICENSE" \
            -not -name "README.md" \
            -delete

          echo "Restoring unsupported addons to root..."
          cp -r ../temp_unsupported/* .
          rm -rf ../temp_unsupported

      - name: ðŸ“ Prepare Unsupported Branch
        run: |
          pip install pyyaml --quiet
          python3 .scripts/prepare_unsupported_branch.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”„ Bump Versions (Dev)
        run: |
          # Bump all found addons to dev (reusing bump_version logic)
          # Note: bump_version might struggle with history if git didn't track moves (cp used above).
          # But since we Force Push, we don't strictly care about "history consistency" for the user,
          # only that the version is unique.
          # bump_version uses git log. If files are new (cp), git log is empty?
          # Actually, we haven't committed the moves yet.
          # So git log on these files (currently untracked/modified) returns nothing?
          # Force add them first to establish tracking?
          # Or just rely on bump_version finding *some* history or falling back?
          # If bump_version fails to find history, it might fail?
          # Let's check bump_version... it runs `git log ... -- path`.

          # To fix this, let's commit the "Move" first so git tracks it (if similar content).
          git add -A
          git commit -m "chore: rearrange unsupported addons [skip ci]" || echo "Nothing to commit"

          # Now bump
          for config in */config.yaml; do
            if [ -f "$config" ]; then
              ADDON_DIR=$(dirname "$config")
              echo "Processing $ADDON_DIR..."
              python3 .scripts/bump_version.py "$ADDON_DIR" patch --dev --changelog 2>/dev/null || echo "Skipping $ADDON_DIR"
            fi
          done

      - name: ðŸš€ Push unsupported branch
        run: |
          git add -A
          git diff --staged --quiet || git commit -m "chore: update unsupported addons [skip ci]"
          git push origin unsupported --force
