name: Orchestrator Maintenance

on:
  workflow_dispatch:
    inputs:
        task:
            description: 'Maintenance Task'
            required: true
            type: choice
            default: 'cleanup'
            options:
            - cleanup
            - retract
        addon:
            description: 'Add-on Slug (for retract)'
            required: false
            type: string
        version:
            description: 'Version to Retract (for retract)'
            required: false
            type: string
  schedule:
    - cron: '0 0 * * 0' # Weekly Cleanup

jobs:
  # --------------------------------------------------------------------------------
  # CLEANUP: Delete old runs & Stale items
  # --------------------------------------------------------------------------------
  cleanup:
    name: üßπ System Cleanup
    if: github.event.inputs.task == 'cleanup' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: üóëÔ∏è Delete Old Workflow Runs
        uses: actions/delete-workflow-runs@v2.0.4
        with:
            retain_days: 30
            keep_minimum_runs: 5

      # Future: Prune Docker Registry script

  # --------------------------------------------------------------------------------
  # RETRACT: Remove specific version
  # --------------------------------------------------------------------------------
  retract:
    name: ‚Ü©Ô∏è Retract Release
    if: github.event.inputs.task == 'retract'
    runs-on: ubuntu-latest
    steps:
        - name: ‚§µÔ∏è Check out code
          uses: actions/checkout@v4

        - name: üö´ Retract Logic
          run: |
            echo "Retracting ${{ github.event.inputs.addon }} version ${{ github.event.inputs.version }}"
            # We assume python dependencies are installed or we use standard lib
            pip install requests
            python3 .scripts/retract_version.py "${{ github.event.inputs.addon }}" "${{ github.event.inputs.version }}"
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
