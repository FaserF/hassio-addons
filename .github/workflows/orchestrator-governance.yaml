name: Orchestrator Governance

on:
  schedule:
    - cron: "0 0 * * 1" # Weekly: Mondays at 00:00
  issues:
    types: [opened, edited]
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  # --------------------------------------------------------------------------------
  # LABELER: Auto-label Issues & PRs
  # --------------------------------------------------------------------------------
  labeler:
    name: üè∑Ô∏è Auto Labeler
    runs-on: ubuntu-latest
    steps:
      - name: üè∑Ô∏è Label Issues (Form-based)
        if: github.event_name == 'issues'
        uses: actions/github-script@v8
        with:
          script: |
            const body = context.payload.issue.body;
            if (!body) return;
            const regex = /### .*(Add-On|Addon).*\n\n([^\n]+)/i;
            const match = body.match(regex);
            if (match && match[2] && match[2] !== 'Other' && match[2] !== '_No response_') {
               const start = match[2].trim();
               const addonName = start.toLowerCase().replace(/ /g, '-');
               const label = `addon/${addonName}`;

               // Dynamic Validation: Check if folder exists
               try {
                  // We need to list files to check existence since we don't have the repo checked out in this step context usually?
                  // Actually, github-script runs on ubuntu-latest. If we haven't checked out code, we can't check fs.
                  // But this job runs `runs-on: ubuntu-latest` and DOES NOT have a checkout step in the snippet I saw!
                  // Uses `actions/github-script`. We can use the API to check content.

                  try {
                    await github.rest.repos.getContent({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      path: `${addonName}/config.yaml`
                    });
                    // If no error, file exists. Proceed.
                    await github.rest.issues.addLabels({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                        labels: [label]
                    });
                  } catch (err) {
                     if (err.status === 404) {
                        console.log(`Addon directory ${addonName} not found or no config.yaml. Skipping label.`);
                     } else {
                        throw err;
                     }
                  }
               } catch (e) {
                  console.log(`Failed to process label ${label}: ${e.message}`);
               }
            }

  # --------------------------------------------------------------------------------
  # STALE: Manage inactive items
  # --------------------------------------------------------------------------------
  stale:
    name: üßπ Stale Check
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          days-before-stale: 60
          days-before-close: 7
          stale-issue-message: "This issue is stale because it has been open 60 days with no activity."
          stale-pr-message: "This PR is stale because it has been open 60 days with no activity."
          stale-issue-label: "stale"
          stale-pr-label: "stale"

  # --------------------------------------------------------------------------------
  # LOCK: Lock old threads
  # --------------------------------------------------------------------------------
  lock:
    name: üîí Lock Threads
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: dessant/lock-threads@v5
        with:
          github-token: ${{ github.token }}
          issue-inactive-days: "60"
          pr-inactive-days: "60"
