name: Orchestrator Release

# Unified release workflow combining:
# - Manual releases (workflow_dispatch)
# - Auto-releases after Renovate PRs merge (pull_request.closed)
# - Scheduled edge updates (schedule)
# - Repository dispatch from other workflows

on:
  workflow_dispatch:
    inputs:
      addon:
        description: "Add-on slug (folder name), 'all' for all add-ons, or 'detect' for auto"
        required: true
        type: string
      version:
        description: "Version increment (major, minor, patch)"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      skip_verification:
        description: "Skip lint/build verification"
        required: false
        default: false
        type: boolean
      changelog_only:
        description: "Only update changelog, don't bump version (versions already correct)"
        required: false
        default: false
        type: boolean

  pull_request:
    types: [closed]
    branches:
      - master

  repository_dispatch:
    types: [dependency-update, base-image-update, auto-release]

  schedule:
    - cron: "0 5 1 * *" # Monthly Edge Updates

  push:
    branches:
      - master
    paths:
      - "**/config.yaml"


permissions:
  contents: write
  packages: write
  actions: write
  pull-requests: read

env:
  # Addons that should get auto-releases on dependency updates
  AUTO_RELEASE_ADDONS: |
    homeassistant-test-instance
    wiki.js
    wiki.js3
    matterbridge
    pterodactyl-wings
    AegisBot
    solumati
    netboot-xyz
    antigravity-server
    whatsapp
    switch_lan_play
    nginx

  # Labels that indicate safe auto-release
  SAFE_LABELS: dependencies automerge

  # Labels that block auto-release
  BLOCK_LABELS: breaking-change major no-release needs-review

jobs:
  # ================================================================================
  # SCHEDULE: Monthly Edge Updates
  # ================================================================================
  schedule-edge:
    name: ðŸ—“ï¸ Monthly Edge Trigger
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: â¤µï¸ Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: ðŸš€ Run Trigger Script
        run: python3 .scripts/trigger_edge_updates.py
        env:
          GITHUB_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

  # ================================================================================
  # DETECT: Determine which addons need release
  # ================================================================================
  detect:
    name: ðŸ” Detect Release Targets
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    outputs:
      addons: ${{ steps.detect.outputs.addons }}
      should_release: ${{ steps.detect.outputs.should_release }}
      is_auto: ${{ steps.detect.outputs.is_auto }}
      version_type: ${{ steps.detect.outputs.version_type }}
      is_manual_bump: ${{ steps.detect.outputs.is_manual_bump }}
    steps:
      - name: â¤µï¸ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: ðŸ” Detect release targets
        id: detect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_MERGED: ${{ github.event.pull_request.merged }}
          PR_LABELS: ${{ toJson(github.event.pull_request.labels.*.name) }}
          INPUT_ADDON: ${{ github.event.inputs.addon }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
          DISPATCH_ADDON: ${{ github.event.client_payload.addon }}
          DISPATCH_VERSION: ${{ github.event.client_payload.version }}
        run: |
          set -e
          ADDONS=""
          SHOULD_RELEASE="false"
          IS_AUTO="false"
          VERSION_TYPE="patch"

          # ----------------------------------------------------------------
          # MANUAL DISPATCH
          # ----------------------------------------------------------------
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            IS_AUTO="false"
            VERSION_TYPE="${INPUT_VERSION:-patch}"

            echo "ðŸ” Manual dispatch detected"
            echo "  INPUT_ADDON: '$INPUT_ADDON'"
            echo "  INPUT_VERSION: '$INPUT_VERSION'"

            if [ "$INPUT_ADDON" == "all" ]; then
              # Find all add-ons (matching Python script logic)
              echo "ðŸ” Finding all add-ons..."
              # Regular addons (top-level directories with config.yaml)
              for item in */; do
                item_name="${item%/}"
                if [ -f "${item}config.yaml" ] && [ ! "${item_name#.}" != "$item_name" ] && [ ! "${item_name#_}" != "$item_name" ]; then
                  # Skip test add-ons
                  if [ "$item_name" != "homeassistant-test-instance" ]; then
                    [ -z "$ADDONS" ] && ADDONS="$item_name" || ADDONS="$ADDONS,$item_name"
                  fi
                fi
              done
              # Unsupported addons
              if [ -d ".unsupported" ]; then
                for item in .unsupported/*/; do
                  if [ -f "${item}config.yaml" ]; then
                    item_name=".unsupported/$(basename "$item")"
                    [ -z "$ADDONS" ] && ADDONS="$item_name" || ADDONS="$ADDONS,$item_name"
                  fi
                done
              fi
              SHOULD_RELEASE="true"
              echo "ðŸ“¦ Found add-ons: $ADDONS"
            elif [ -n "$INPUT_ADDON" ] && [ "$INPUT_ADDON" != "detect" ]; then
              # Single addon specified
              ADDONS="$INPUT_ADDON"
              SHOULD_RELEASE="true"
              echo "ðŸ“¦ Single addon specified: $ADDONS"
            else
              echo "âš ï¸ Invalid or missing addon input: '$INPUT_ADDON'"
              SHOULD_RELEASE="false"
            fi

          # ----------------------------------------------------------------
          # REPOSITORY DISPATCH
          # ----------------------------------------------------------------
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            IS_AUTO="true"
            VERSION_TYPE="${DISPATCH_VERSION:-patch}"

            if [ -n "$DISPATCH_ADDON" ]; then
              ADDONS="$DISPATCH_ADDON"
              SHOULD_RELEASE="true"
            fi

          # ----------------------------------------------------------------
          # MERGED PR (Auto-release)
          # ----------------------------------------------------------------
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            IS_AUTO="true"

            # Check if PR was merged
            if [ "$PR_MERGED" != "true" ]; then
              echo "PR was not merged, skipping."
              {
                echo "should_release=false"
                echo "addons=[]"
                echo "is_auto=false"
                echo "version_type=patch"
              } >> "$GITHUB_OUTPUT"
              exit 0
            fi

            # Check for blocking labels
            CLEAN_BLOCK_LABELS=$(echo "${{ env.BLOCK_LABELS }}" | tr '\n' ' ')
            for label in $CLEAN_BLOCK_LABELS; do
              if echo "$PR_LABELS" | grep -qi "\"$label\""; then
                echo "â›” Found blocking label: $label"
                {
                  echo "should_release=false"
                  echo "addons=[]"
                  echo "is_auto=true"
                  echo "version_type=patch"
                } >> "$GITHUB_OUTPUT"
                exit 0
              fi
            done

            # Check for safe labels
            HAS_SAFE="false"
            CLEAN_SAFE_LABELS=$(echo "${{ env.SAFE_LABELS }}" | tr '\n' ' ')
            for label in $CLEAN_SAFE_LABELS; do
              if echo "$PR_LABELS" | grep -qi "\"$label\""; then
                HAS_SAFE="true"
                break
              fi
            done

            if [ "$HAS_SAFE" != "true" ]; then
              echo "No safe labels found"
              {
                echo "should_release=false"
                echo "addons=[]"
                echo "is_auto=true"
                echo "version_type=patch"
              } >> "$GITHUB_OUTPUT"
              exit 0
            fi

            # Get changed files
            CHANGED=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path' || echo "")

            # Detect affected auto-release addons
            # Use grep -F for fixed string matching (handles special chars like . in wiki.js)
            CLEAN_AUTO_ADDONS="$(echo "${{ env.AUTO_RELEASE_ADDONS }}" | tr '\n' ' ')"
            for addon in $CLEAN_AUTO_ADDONS; do
              if echo "$CHANGED" | grep -Fq "${addon}/"; then
                [ -z "$ADDONS" ] && ADDONS="$addon" || ADDONS="$ADDONS,$addon"
              fi
              # Check .unsupported too
              if echo "$CHANGED" | grep -Fq ".unsupported/${addon}/"; then
                [ -z "$ADDONS" ] && ADDONS=".unsupported/$addon" || ADDONS="$ADDONS,.unsupported/$addon"
              fi
            done

            [ -n "$ADDONS" ] && SHOULD_RELEASE="true"
          # ----------------------------------------------------------------
          # PUSH TO MASTER (Manual Version Bump Detection)
          # ----------------------------------------------------------------
          elif [ "${{ github.event_name }}" == "push" ]; then
             IS_AUTO="false"

             # Get list of changed files
             CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)

             for file in $CHANGED_FILES; do
               if [[ "$file" == *"/config.yaml" ]]; then
                 addon_dir=$(dirname "$file")
                 addon_name=$(basename "$addon_dir")

                 # Check if version changed
                 # We need to install yq or use python to check versions reliably, or simple grep
                 # Let's use python one-liner since we have python environment

                 # Get old version
                 OLD_VERSION=$(git show HEAD^:"$file" | grep "^version:" | head -n 1 | awk '{print $2}' | tr -d '"' | tr -d "'")
                 # Get new version
                 NEW_VERSION=$(grep "^version:" "$file" | head -n 1 | awk '{print $2}' | tr -d '"' | tr -d "'")

                 if [ "$OLD_VERSION" != "$NEW_VERSION" ] && [ -n "$NEW_VERSION" ]; then
                    echo "ðŸš€ Detected version bump in $addon_name: $OLD_VERSION -> $NEW_VERSION"
                    [ -z "$ADDONS" ] && ADDONS="$addon_name" || ADDONS="$ADDONS,$addon_name"
                    SHOULD_RELEASE="true"
                    IS_MANUAL_BUMP="true"
                    VERSION_TYPE="$NEW_VERSION" # Pass exact version
                 fi
               fi
             done

          fi

          # Convert to JSON array (compact format for GitHub Actions output)
          if [ -n "$ADDONS" ]; then
            JSON="$(echo "$ADDONS" | tr ',' '\n' | jq -R . | jq -s -c .)"
          else
            JSON="[]"
          fi

          echo "Addons: $ADDONS"
          echo "Should release: $SHOULD_RELEASE"
          echo "Is auto: $IS_AUTO"
          echo "Version type: $VERSION_TYPE"
          echo "Is manual bump: ${IS_MANUAL_BUMP:-false}"

          # Output as compact JSON (single line) to avoid formatting issues
          {
            echo "addons=$JSON"
            echo "should_release=$SHOULD_RELEASE"
            echo "is_auto=$IS_AUTO"
            echo "version_type=$VERSION_TYPE"
            echo "is_manual_bump=${IS_MANUAL_BUMP:-false}"
          } >> "$GITHUB_OUTPUT"

  # ================================================================================
  # VERIFY: Lint and test build before release
  # ================================================================================
  verify:
    name: âœ… Verify ${{ matrix.addon }}
    needs: detect
    if: needs.detect.outputs.should_release == 'true' && github.event.inputs.skip_verification != 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        addon: ${{ fromJson(needs.detect.outputs.addons) }}
    steps:
      - name: â¤µï¸ Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: ðŸ•µï¸ Add-on Linter
        uses: frenck/action-addon-linter@f995494fd84fae6310d23617e66d0e37de4f14eb # v2.21.0
        with:
          path: "./${{ matrix.addon }}"

      - name: â„¹ï¸ Get Add-on Info
        id: info
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ matrix.addon }}"

      - name: ðŸ—ï¸ Test Build
        uses: home-assistant/builder@2025.11.0
        with:
          args: |
            --test \
            --target /data/${{ matrix.addon }} \
            --image "${{ steps.info.outputs.image }}" \
            --docker-hub "ghcr.io/${{ github.repository_owner }}" \
            --addon \
            --docker-args "--build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

  # ================================================================================
  # RELEASE: Build & Push
  # ================================================================================
  release:
    name: ðŸš€ Release ${{ matrix.addon }}
    needs: [detect, verify]
    if: |
      always() &&
      needs.detect.outputs.should_release == 'true' &&
      (needs.verify.result == 'success' || needs.verify.result == 'skipped' || github.event.inputs.skip_verification == 'true')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        addon: ${{ fromJson(needs.detect.outputs.addons) }}
    steps:
      - name: â¤µï¸ Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Detect if unsupported
        id: status
        run: |
          # shellcheck disable=SC2193
          if [[ "${{ matrix.addon }}" == .unsupported/* ]]; then
            echo "is_unsupported=true" >> "$GITHUB_OUTPUT"
            echo "ðŸ“¦ Addon is UNSUPPORTED"
          else
            echo "is_unsupported=false" >> "$GITHUB_OUTPUT"
          fi

      - name: ðŸ”§ Inject Version Warning
        run: |
          pip install pyyaml --quiet
          python3 .scripts/inject_version_warning.py "${{ matrix.addon }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: â„¹ï¸ Get Add-on Info
        id: info
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ matrix.addon }}"

      - name: ðŸ‹ Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“ Bump Version & Changelog
        run: |
          VERSION_TYPE="${{ needs.detect.outputs.version_type }}"
          IS_AUTO="${{ needs.detect.outputs.is_auto }}"
          IS_MANUAL_BUMP="${{ needs.detect.outputs.is_manual_bump }}"
          CHANGELOG_ONLY="${{ github.event.inputs.changelog_only || 'false' }}"

          if [ "$IS_AUTO" == "true" ]; then
            MSG="Automatic release after dependency update"
          else
            MSG="Manual release via Orchestrator"
          fi

          if [ "$IS_MANUAL_BUMP" == "true" ] || [ "$CHANGELOG_ONLY" == "true" ]; then
             echo "â„¹ï¸ Changelog-only mode: Updating Changelog without version bump."
             # Get current version from config.yaml
             CURRENT_VERSION=$(grep "^version:" "${{ matrix.addon }}/config.yaml" | head -n 1 | awk '{print $2}' | tr -d '"' | tr -d "'")
             python3 .scripts/bump_version.py "${{ matrix.addon }}" patch --target-version "$CURRENT_VERSION" --changelog-only --message "$MSG"
          else
             python3 .scripts/bump_version.py "${{ matrix.addon }}" "$VERSION_TYPE" --message "$MSG"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸš€ Commit Changes
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          commit_message: |
            ${{ github.event.inputs.changelog_only == 'true' && format('ðŸ“ release({0}): update changelog [skip-tests]', matrix.addon) || format('ðŸš€ release({0}): version bump [skip-tests]', matrix.addon) }}
          file_pattern: "${{ matrix.addon }}/*"

      - name: â„¹ï¸ Get Add-on Info (Post-Bump)
        id: info_build
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ matrix.addon }}"

      - name: ðŸ—ï¸ Build & Push Add-on
        uses: home-assistant/builder@2025.11.0
        with:
          args: |
            --aarch64 \
            --amd64 \
            --target /data/${{ matrix.addon }} \
            --image "${{ steps.info_build.outputs.image }}" \
            --docker-hub "ghcr.io/${{ github.repository_owner }}" \
            --addon \
            --docker-args "--build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --no-cache

      - name: ðŸ”„ Bump to Dev Version
        if: |
          success() &&
          github.event.inputs.changelog_only != 'true'
        run: |
          python3 .scripts/bump_version.py "${{ matrix.addon }}" patch --dev
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸš€ Commit Dev Version
        if: |
          success() &&
          github.event.inputs.changelog_only != 'true'
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          commit_message: "chore(${{ matrix.addon }}): bump to dev version [skip-tests]"
          file_pattern: "${{ matrix.addon }}/*"

      - name: ðŸ“¢ Release Summary
        run: |
          {
            echo "### ðŸš€ Release Complete"
            echo ""
            echo "**Add-on:** ${{ matrix.addon }}"
            echo "**Type:** ${{ needs.detect.outputs.is_auto == 'true' && 'Auto-release' || 'Manual release' }}"
            echo "**Unsupported:** ${{ steps.status.outputs.is_unsupported }}"
            echo "**Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          } >> "$GITHUB_STEP_SUMMARY"
