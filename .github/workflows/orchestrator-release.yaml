name: Orchestrator Release

# Unified release workflow combining:
# - Manual releases (workflow_dispatch)
# - Auto-releases after Renovate PRs merge (pull_request.closed)
# - Repository dispatch from other workflows

on:
  workflow_dispatch:
    inputs:
      addon:
        description: "Add-on slug (folder name), 'all' for all add-ons, or 'detect' for auto"
        required: true
        type: string
      version:
        description: "Version increment (major, minor, patch)"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      skip_verification:
        description: "Skip lint/build verification"
        required: false
        default: false
        type: boolean
      changelog_only:
        description: "Only update changelog, don't bump version (versions already correct)"
        required: false
        default: false
        type: boolean

  pull_request:
    types: [closed]
    branches:
      - master

  repository_dispatch:
    types: [dependency-update, base-image-update, auto-release]

  push:
    branches:
      - master
    paths:
      - "**/config.yaml"
      - ".github/workflows/orchestrator-release.yaml"


permissions:
  contents: write
  packages: write
  actions: write
  pull-requests: read

env:
  # Addons that should get auto-releases on dependency updates
  AUTO_RELEASE_ADDONS: |
    homeassistant-test-instance
    wiki.js
    wiki.js3
    matterbridge
    pterodactyl-wings
    AegisBot
    solumati
    netboot-xyz
    antigravity-server
    whatsapp
    switch_lan_play
    nginx

  # Labels that indicate safe auto-release
  SAFE_LABELS: dependencies automerge

  # Labels that block auto-release
  BLOCK_LABELS: breaking-change major no-release needs-review

jobs:
  # ================================================================================
  # DETECT: Determine which addons need release
  # ================================================================================
  detect:
    name: üîç Detect Release Targets
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'repository_dispatch' ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'release(all)'))
    runs-on: ubuntu-latest
    outputs:
      addons: ${{ steps.detect.outputs.addons }}
      should_release: ${{ steps.detect.outputs.should_release }}
      is_auto: ${{ steps.detect.outputs.is_auto }}
      version_type: ${{ steps.detect.outputs.version_type }}
      is_manual_bump: ${{ steps.detect.outputs.is_manual_bump }}
    steps:
      - name: ‚§µÔ∏è Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: üîç Detect release targets
        id: detect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_MERGED: ${{ github.event.pull_request.merged }}
          PR_LABELS: ${{ toJson(github.event.pull_request.labels.*.name) }}
          INPUT_ADDON: ${{ github.event.inputs.addon }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
          DISPATCH_ADDON: ${{ github.event.client_payload.addon }}
          DISPATCH_VERSION: ${{ github.event.client_payload.version }}
        run: |
          set -e
          ADDONS=""
          SHOULD_RELEASE="false"
          IS_AUTO="false"
          VERSION_TYPE="patch"

          # ----------------------------------------------------------------
          # MANUAL DISPATCH
          # ----------------------------------------------------------------
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            IS_AUTO="false"
            VERSION_TYPE="${INPUT_VERSION:-patch}"

            echo "üîç Manual dispatch detected"
            echo "  INPUT_ADDON: '$INPUT_ADDON'"
            echo "  INPUT_VERSION: '$INPUT_VERSION'"

            if [ "$INPUT_ADDON" == "all" ]; then
              # Find all add-ons (matching Python script logic)
              echo "üîç Finding all add-ons..."
              SKIP_ADDONS="homeassistant-test-instance"

              # Regular addons (top-level directories with config.yaml)
              for item in */; do
                item_name="${item%/}"
                if [ -f "${item}config.yaml" ] && [ ! "${item_name#.}" != "$item_name" ] && [ ! "${item_name#_}" != "$item_name" ]; then
                  # Skip test add-ons
                  skip=false
                  for skip_item in $SKIP_ADDONS; do
                    if [ "$item_name" == "$skip_item" ]; then
                      skip=true
                      break
                    fi
                  done
                  if [ "$skip" == "false" ]; then
                    [ -z "$ADDONS" ] && ADDONS="$item_name" || ADDONS="$ADDONS,$item_name"
                  fi
                fi
              done

              # Unsupported addons
              if [ -d ".unsupported" ]; then
                for item in .unsupported/*/; do
                  if [ -f "${item}config.yaml" ]; then
                    item_name=".unsupported/$(basename "$item")"
                    [ -z "$ADDONS" ] && ADDONS="$item_name" || ADDONS="$ADDONS,$item_name"
                  fi
                done
              fi

              SHOULD_RELEASE="true"
              echo "üì¶ Found add-ons: $ADDONS"
              echo "Count: $(echo "$ADDONS" | tr ',' '\n' | wc -l)"
            elif [ -n "$INPUT_ADDON" ] && [ "$INPUT_ADDON" != "detect" ]; then
              # Single addon specified
              ADDONS="$INPUT_ADDON"
              SHOULD_RELEASE="true"
              echo "üì¶ Single addon specified: $ADDONS"
            else
              echo "‚ö†Ô∏è Invalid or missing addon input: '$INPUT_ADDON'"
              SHOULD_RELEASE="false"
            fi

          # ----------------------------------------------------------------
          # REPOSITORY DISPATCH
          # ----------------------------------------------------------------
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            IS_AUTO="true"
            VERSION_TYPE="${DISPATCH_VERSION:-patch}"

            if [ -n "$DISPATCH_ADDON" ]; then
              ADDONS="$DISPATCH_ADDON"
              SHOULD_RELEASE="true"
            fi

          # ----------------------------------------------------------------
          # MERGED PR (Auto-release)
          # ----------------------------------------------------------------
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            IS_AUTO="true"

            # Check if PR was merged
            if [ "$PR_MERGED" != "true" ]; then
              echo "PR was not merged, skipping."
              {
                echo "should_release=false"
                echo "addons=[]"
                echo "is_auto=false"
                echo "version_type=patch"
              } >> "$GITHUB_OUTPUT"
              exit 0
            fi

            # Check for blocking labels
            CLEAN_BLOCK_LABELS=$(echo "${{ env.BLOCK_LABELS }}" | tr '\n' ' ')
            for label in $CLEAN_BLOCK_LABELS; do
              if echo "$PR_LABELS" | grep -qi "\"$label\""; then
                echo "‚õî Found blocking label: $label"
                {
                  echo "should_release=false"
                  echo "addons=[]"
                  echo "is_auto=true"
                  echo "version_type=patch"
                } >> "$GITHUB_OUTPUT"
                exit 0
              fi
            done

            # Check for safe labels
            HAS_SAFE="false"
            CLEAN_SAFE_LABELS=$(echo "${{ env.SAFE_LABELS }}" | tr '\n' ' ')
            for label in $CLEAN_SAFE_LABELS; do
              if echo "$PR_LABELS" | grep -qi "\"$label\""; then
                HAS_SAFE="true"
                break
              fi
            done

            if [ "$HAS_SAFE" != "true" ]; then
              echo "No safe labels found"
              {
                echo "should_release=false"
                echo "addons=[]"
                echo "is_auto=true"
                echo "version_type=patch"
              } >> "$GITHUB_OUTPUT"
              exit 0
            fi

            # Get changed files
            CHANGED=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path' || echo "")

            # Check if this is a base image update by checking PR title/description
            IS_BASE_IMAGE_UPDATE="false"
            PR_TITLE=$(gh pr view "$PR_NUMBER" --json title --jq '.title' || echo "")
            PR_BODY=$(gh pr view "$PR_NUMBER" --json body --jq '.body' || echo "")
            if echo "$PR_TITLE $PR_BODY" | grep -qiE "(base.*image|hassio-addons/(base|debian-base|base-python)|Add-on base images)"; then
              IS_BASE_IMAGE_UPDATE="true"
              echo "üîç Base image update detected from PR title/description"
            fi

            # If base image update, release ALL affected addons (not just AUTO_RELEASE_ADDONS)
            if [ "$IS_BASE_IMAGE_UPDATE" == "true" ]; then
              echo "üîç Base image update - releasing all affected addons"
              # Find all addons with changed Dockerfile or build.yaml
              for file in $CHANGED; do
                # Extract addon directory from file path
                if [[ "$file" =~ ^\.unsupported/([^/]+)/ ]]; then
                  addon_dir=".unsupported/${BASH_REMATCH[1]}"
                elif [[ "$file" =~ ^([^/]+)/ ]]; then
                  addon_dir="${BASH_REMATCH[1]}"
                else
                  continue
                fi

                # Check if Dockerfile or build.yaml in this addon was changed
                if echo "$CHANGED" | grep -qE "^${addon_dir}/(Dockerfile|build\.yaml)$"; then
                  # Skip if already added
                  if [[ ! ",$ADDONS," =~ ,"$addon_dir", ]]; then
                    [ -z "$ADDONS" ] && ADDONS="$addon_dir" || ADDONS="$ADDONS,$addon_dir"
                    echo "  ‚úÖ Added $addon_dir (Dockerfile/build.yaml changed)"
                  fi
                fi
              done
            else
              # Normal dependency update - only release addons in AUTO_RELEASE_ADDONS list
              echo "üîç Normal dependency update - checking AUTO_RELEASE_ADDONS list"
              CLEAN_AUTO_ADDONS="$(echo "${{ env.AUTO_RELEASE_ADDONS }}" | tr '\n' ' ')"
              for addon in $CLEAN_AUTO_ADDONS; do
                if echo "$CHANGED" | grep -Fq "${addon}/"; then
                  [ -z "$ADDONS" ] && ADDONS="$addon" || ADDONS="$ADDONS,$addon"
                fi
                # Check .unsupported too
                if echo "$CHANGED" | grep -Fq ".unsupported/${addon}/"; then
                  [ -z "$ADDONS" ] && ADDONS=".unsupported/$addon" || ADDONS="$ADDONS,.unsupported/$addon"
                fi
              done
            fi

            [ -n "$ADDONS" ] && SHOULD_RELEASE="true"
          # ----------------------------------------------------------------
          # PUSH TO MASTER (Manual Version Bump Detection or release(all) trigger)
          # ----------------------------------------------------------------
          elif [ "${{ github.event_name }}" == "push" ]; then
             IS_AUTO="false"

             # Check for "release(all)" in commit message
             COMMIT_MSG="${github.event.head_commit.message}"
             if echo "$COMMIT_MSG" | grep -qi "release(all)"; then
               echo "üöÄ Detected 'release(all)' in commit message - releasing all add-ons"
               SKIP_ADDONS="homeassistant-test-instance"

               # Regular addons (top-level directories with config.yaml)
               for item in */; do
                 item_name="${item%/}"
                 if [ -f "${item}config.yaml" ] && [ ! "${item_name#.}" != "$item_name" ] && [ ! "${item_name#_}" != "$item_name" ]; then
                   # Skip test add-ons
                   skip=false
                   for skip_item in $SKIP_ADDONS; do
                     if [ "$item_name" == "$skip_item" ]; then
                       skip=true
                       break
                     fi
                   done
                   if [ "$skip" == "false" ]; then
                     [ -z "$ADDONS" ] && ADDONS="$item_name" || ADDONS="$ADDONS,$item_name"
                   fi
                 fi
               done

               # Unsupported addons
               if [ -d ".unsupported" ]; then
                 for item in .unsupported/*/; do
                   if [ -f "${item}config.yaml" ]; then
                     item_name=".unsupported/$(basename "$item")"
                     [ -z "$ADDONS" ] && ADDONS="$item_name" || ADDONS="$ADDONS,$item_name"
                   fi
                 done
               fi

               SHOULD_RELEASE="true"
               VERSION_TYPE="patch" # Default for release(all)
               echo "üì¶ Found add-ons: $ADDONS"
             else
               # Original logic: Detect manual version bumps
               # Get list of changed files
               CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)

               for file in $CHANGED_FILES; do
                 if [[ "$file" == *"/config.yaml" ]]; then
                   addon_dir=$(dirname "$file")
                   addon_name=$(basename "$addon_dir")

                   # Check if version changed
                   # Get old version
                   OLD_VERSION=$(git show HEAD^:"$file" | grep "^version:" | head -n 1 | awk '{print $2}' | tr -d '"' | tr -d "'")
                   # Get new version
                   NEW_VERSION=$(grep "^version:" "$file" | head -n 1 | awk '{print $2}' | tr -d '"' | tr -d "'")

                   if [ "$OLD_VERSION" != "$NEW_VERSION" ] && [ -n "$NEW_VERSION" ]; then
                      echo "üöÄ Detected version bump in $addon_name: $OLD_VERSION -> $NEW_VERSION"
                      [ -z "$ADDONS" ] && ADDONS="$addon_name" || ADDONS="$ADDONS,$addon_name"
                      SHOULD_RELEASE="true"
                      IS_MANUAL_BUMP="true"
                      VERSION_TYPE="$NEW_VERSION" # Pass exact version
                   fi
                 fi
               done
             fi

          fi

          # Convert to JSON array (compact format for GitHub Actions output)
          if [ -n "$ADDONS" ]; then
            JSON="$(echo "$ADDONS" | tr ',' '\n' | jq -R . | jq -s -c .)"
          else
            JSON="[]"
          fi

          echo "Addons: $ADDONS"
          echo "Should release: $SHOULD_RELEASE"
          echo "Is auto: $IS_AUTO"
          echo "Version type: $VERSION_TYPE"
          echo "Is manual bump: ${IS_MANUAL_BUMP:-false}"

          # Output as compact JSON (single line) to avoid formatting issues
          {
            echo "addons=$JSON"
            echo "should_release=$SHOULD_RELEASE"
            echo "is_auto=$IS_AUTO"
            echo "version_type=$VERSION_TYPE"
            echo "is_manual_bump=${IS_MANUAL_BUMP:-false}"
          } >> "$GITHUB_OUTPUT"

  # ================================================================================
  # VERIFY: Lint and test build before release
  # ================================================================================
  verify:
    name: ‚úÖ Verify ${{ matrix.addon }}
    needs: detect
    if: needs.detect.outputs.should_release == 'true' && github.event.inputs.skip_verification != 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        addon: ${{ fromJson(needs.detect.outputs.addons) }}
    steps:
      - name: ‚§µÔ∏è Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: üïµÔ∏è Add-on Linter
        uses: frenck/action-addon-linter@f995494fd84fae6310d23617e66d0e37de4f14eb # v2.21.0
        with:
          path: "./${{ matrix.addon }}"

      - name: ‚ÑπÔ∏è Get Add-on Info
        id: info
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ matrix.addon }}"

      - name: üèóÔ∏è Test Build
        uses: home-assistant/builder@2025.11.0
        with:
          args: |
            --test \
            --amd64 \
            --target /data/${{ matrix.addon }} \
            --image "${{ steps.info.outputs.image }}" \
            --docker-hub "ghcr.io/${{ github.repository_owner }}" \
            --addon

  # ================================================================================
  # RELEASE: Build & Push
  # ================================================================================
  release:
    name: üöÄ Release ${{ matrix.addon }}
    needs: [detect, verify]
    if: |
      always() &&
      needs.detect.outputs.should_release == 'true' &&
      (needs.verify.result == 'success' || needs.verify.result == 'skipped' || github.event.inputs.skip_verification == 'true')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        addon: ${{ fromJson(needs.detect.outputs.addons) }}
    steps:
      - name: ‚§µÔ∏è Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Detect if unsupported
        id: status
        run: |
          # shellcheck disable=SC2193
          if [[ "${{ matrix.addon }}" == .unsupported/* ]]; then
            echo "is_unsupported=true" >> "$GITHUB_OUTPUT"
            echo "üì¶ Addon is UNSUPPORTED"
          else
            echo "is_unsupported=false" >> "$GITHUB_OUTPUT"
          fi

      - name: üîß Inject Version Warning
        run: |
          pip install pyyaml --quiet
          python3 .scripts/inject_version_warning.py "${{ matrix.addon }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚ÑπÔ∏è Get Add-on Info
        id: info
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ matrix.addon }}"

      - name: üêã Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üìù Bump Version & Changelog
        run: |
          VERSION_TYPE="${{ needs.detect.outputs.version_type }}"
          IS_AUTO="${{ needs.detect.outputs.is_auto }}"
          IS_MANUAL_BUMP="${{ needs.detect.outputs.is_manual_bump }}"
          CHANGELOG_ONLY="${{ github.event.inputs.changelog_only || 'false' }}"

          if [ "$IS_AUTO" == "true" ]; then
            MSG="Automatic release after dependency update"
          else
            MSG="Manual release via Orchestrator"
          fi

          if [ "$IS_MANUAL_BUMP" == "true" ] || [ "$CHANGELOG_ONLY" == "true" ]; then
             echo "‚ÑπÔ∏è Changelog-only mode: Updating Changelog without version bump."
             # Get current version from config.yaml
             CURRENT_VERSION=$(grep "^version:" "${{ matrix.addon }}/config.yaml" | head -n 1 | awk '{print $2}' | tr -d '"' | tr -d "'")
             python3 .scripts/bump_version.py "${{ matrix.addon }}" patch --target-version "$CURRENT_VERSION" --changelog-only --message "$MSG"
          else
             python3 .scripts/bump_version.py "${{ matrix.addon }}" "$VERSION_TYPE" --message "$MSG"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üîÑ Pull latest changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Fetch latest changes
          git fetch origin master
          # Try to rebase, if that fails try merge
          git rebase origin/master || git merge origin/master --no-edit || echo "Pull/rebase failed, continuing..."

      - name: üöÄ Commit Changes
        id: commit_changes
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          commit_message: |
            ${{ github.event.inputs.changelog_only == 'true' && format('üìù release({0}): update changelog [skip-tests]', matrix.addon) || format('üöÄ release({0}): version bump [skip-tests]', matrix.addon) }}
          file_pattern: "${{ matrix.addon }}/*"
          skip_fetch: true

      - name: üîÑ Retry Commit with Pull (if failed)
        if: steps.commit_changes.outcome == 'failure'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Pull latest changes
          git fetch origin master
          git rebase origin/master || git merge origin/master --no-edit
          # Check if there are changes to commit
          if [ -n "$(git status --porcelain ${{ matrix.addon }}/*)" ]; then
            git add "${{ matrix.addon }}/*"
            git commit -m "${{ github.event.inputs.changelog_only == 'true' && format('üìù release({0}): update changelog [skip-tests]', matrix.addon) || format('üöÄ release({0}): version bump [skip-tests]', matrix.addon) }}" --author="FaserF <12374134+FaserF@users.noreply.github.com>" || echo "Nothing to commit"
            git push origin master || echo "Push failed"
          fi

      - name: ‚ÑπÔ∏è Get Add-on Info (Post-Bump)
        id: info_build
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ matrix.addon }}"

      - name: üóëÔ∏è Delete existing image version (if exists)
        continue-on-error: true
        run: |
          # Extract version from config.yaml
          VERSION=$(grep "^version:" "${{ matrix.addon }}/config.yaml" | head -n 1 | awk '{print $2}' | tr -d '"' | tr -d "'")
          IMAGE_NAME="${{ steps.info_build.outputs.image }}"

          # Extract package name from image (remove ghcr.io/owner/ prefix and any arch suffix)
          # Image format: ghcr.io/owner/package-{arch} or ghcr.io/owner/package
          PACKAGE_NAME=$(echo "$IMAGE_NAME" | sed 's|ghcr.io/[^/]*/||' | sed 's/-amd64$//' | sed 's/-aarch64$//' | sed 's/-armhf$//' | sed 's/-armv7$//' | sed 's/-i386$//')
          OWNER="${{ github.repository_owner }}"

          echo "üîç Checking for existing image: $PACKAGE_NAME:$VERSION"

          # Get GitHub API token
          TOKEN="${{ secrets.GITHUB_TOKEN }}"

          # Function to delete version from a package
          delete_version() {
            local pkg_name=$1
            local version=$2
            local base_url=$3

            RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: Bearer ${TOKEN}" -H "Accept: application/vnd.github.v3+json" "$base_url")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            VERSIONS_JSON=$(echo "$RESPONSE" | sed '$d')

            if [ "$HTTP_CODE" = "200" ]; then
              # Find version ID for the specific version tag
              VERSION_ID=$(echo "$VERSIONS_JSON" | jq -r ".[] | select(.metadata.container.tags[]? == \"$version\") | .id" | head -n1)

              if [ -n "$VERSION_ID" ] && [ "$VERSION_ID" != "null" ]; then
                echo "üóëÔ∏è Found existing version $version (ID: $VERSION_ID) for $pkg_name, deleting..."
                DELETE_URL="${base_url}/${VERSION_ID}"
                DELETE_RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE -H "Authorization: Bearer ${TOKEN}" -H "Accept: application/vnd.github.v3+json" "$DELETE_URL")
                DELETE_CODE=$(echo "$DELETE_RESPONSE" | tail -n1)

                if [ "$DELETE_CODE" = "204" ]; then
                  echo "‚úÖ Successfully deleted existing version $version for $pkg_name"
                  return 0
                else
                  echo "‚ö†Ô∏è Failed to delete version (HTTP $DELETE_CODE)"
                  return 1
                fi
              fi
            fi
            return 1
          }

          # Try org endpoint first, then user endpoint
          ORG_URL="https://api.github.com/orgs/${OWNER}/packages/container/${PACKAGE_NAME}/versions"
          USER_URL="https://api.github.com/users/${OWNER}/packages/container/${PACKAGE_NAME}/versions"

          if ! delete_version "$PACKAGE_NAME" "$VERSION" "$ORG_URL"; then
            if ! delete_version "$PACKAGE_NAME" "$VERSION" "$USER_URL"; then
              echo "‚ÑπÔ∏è No existing version $VERSION found for $PACKAGE_NAME, proceeding with build"
            fi
          fi

      - name: üèóÔ∏è Build & Push Add-on
        run: |
          # Read architectures from config.yaml
          ARCHS=$(grep -A 10 "^arch:" "${{ matrix.addon }}/config.yaml" | grep -E "^\s+-" | sed 's/^\s*-\s*//' | tr '\n' ' ' | xargs || echo "")
          
          # Default to amd64 and aarch64 if no arches found
          if [ -z "$ARCHS" ]; then
            ARCHS="amd64 aarch64"
          fi
          
          echo "üîç Detected architectures: $ARCHS"
          
          # Build builder args based on supported architectures (only amd64 and aarch64)
          # Note: armhf, armv7, and i386 are not supported by this repo
          BUILDER_ARGS=""
          for arch in $ARCHS; do
            case "$arch" in
              amd64)
                BUILDER_ARGS="${BUILDER_ARGS}--amd64 \\\\n            "
                ;;
              aarch64)
                BUILDER_ARGS="${BUILDER_ARGS}--aarch64 \\\\n            "
                ;;
              armhf|armv7|i386)
                echo "‚ö†Ô∏è Skipping unsupported architecture: $arch"
                ;;
            esac
          done
          
          # Remove trailing backslash and newline
          BUILDER_ARGS=$(echo -e "$BUILDER_ARGS" | sed 's/\\\\n[[:space:]]*$//')
          
          # Ensure at least amd64 and aarch64 are built
          if [ -z "$BUILDER_ARGS" ]; then
            BUILDER_ARGS="--amd64 \\\\n            --aarch64"
            BUILDER_ARGS=$(echo -e "$BUILDER_ARGS" | sed 's/\\\\n[[:space:]]*$//')
          fi
          
          echo "üèóÔ∏è Building with args:"
          echo -e "$BUILDER_ARGS"
          
          # Use docker run directly to have full control over args
          docker run --rm --privileged \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v "$(pwd)":/data \
            ghcr.io/home-assistant/amd64-builder:2025.11.0 \
            $(echo -e "$BUILDER_ARGS") \
            --target "/data/${{ matrix.addon }}" \
            --image "${{ steps.info_build.outputs.image }}" \
            --docker-hub "ghcr.io/${{ github.repository_owner }}" \
            --addon \
            --no-cache

      - name: üîÑ Bump to Dev Version
        if: |
          success() &&
          github.event.inputs.changelog_only != 'true'
        run: |
          python3 .scripts/bump_version.py "${{ matrix.addon }}" patch --dev
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üîÑ Pull latest changes (before dev commit)
        if: |
          success() &&
          github.event.inputs.changelog_only != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Fetch latest changes
          git fetch origin master
          # Try to rebase, if that fails try merge
          git rebase origin/master || git merge origin/master --no-edit || echo "Pull/rebase failed, continuing..."

      - name: üöÄ Commit Dev Version
        id: commit_dev
        if: |
          success() &&
          github.event.inputs.changelog_only != 'true'
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          commit_message: "chore(${{ matrix.addon }}): bump to dev version [skip-tests]"
          file_pattern: "${{ matrix.addon }}/*"
          skip_fetch: true

      - name: üîÑ Retry Dev Commit with Pull (if failed)
        if: |
          steps.commit_dev.outcome == 'failure' &&
          success() &&
          github.event.inputs.changelog_only != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Pull latest changes
          git fetch origin master
          git rebase origin/master || git merge origin/master --no-edit
          # Check if there are changes to commit
          if [ -n "$(git status --porcelain ${{ matrix.addon }}/*)" ]; then
            git add "${{ matrix.addon }}/*"
            git commit -m "chore(${{ matrix.addon }}): bump to dev version [skip-tests]" --author="FaserF <12374134+FaserF@users.noreply.github.com>" || echo "Nothing to commit"
            git push origin master || echo "Push failed"
          fi

      - name: üì¢ Release Summary
        run: |
          {
            echo "### üöÄ Release Complete"
            echo ""
            echo "**Add-on:** ${{ matrix.addon }}"
            echo "**Type:** ${{ needs.detect.outputs.is_auto == 'true' && 'Auto-release' || 'Manual release' }}"
            echo "**Unsupported:** ${{ steps.status.outputs.is_unsupported }}"
            echo "**Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          } >> "$GITHUB_STEP_SUMMARY"
