name: Orchestrator Release

on:
  workflow_dispatch:
    inputs:
      addon:
        description: "Add-on slug (folder name)"
        required: true
        type: string
      version:
        description: "Version increment (major, minor, patch)"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
  repository_dispatch:
    types: [dependency-update, base-image-update]
  schedule:
    - cron: "0 5 1 * *" # Monthly Edge Updates

jobs:
  # --------------------------------------------------------------------------------
  # SCHEDULE: Monthly Edge Updates
  # --------------------------------------------------------------------------------
  schedule-edge:
    name: üóìÔ∏è Monthly Edge Trigger
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Check out code
        uses: actions/checkout@v4

      - name: üöÄ Run Trigger Script
        run: python3 .scripts/trigger_edge_updates.py
        env:
          GITHUB_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

  # --------------------------------------------------------------------------------
  # VERIFY: Functional Check Before Release
  # --------------------------------------------------------------------------------
  verify:
    name: ‚úÖ Verify ${{ github.event.inputs.addon || 'Automated' }}
    needs: [schedule-edge] # Optional dependency to ensure order if needed, but they are disjoint
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Check out code
        uses: actions/checkout@v4

      # If manual dispatch, verify the specific add-on
      - name: üïµÔ∏è Add-on Linter (Manual)
        if: github.event_name == 'workflow_dispatch'
        uses: frenck/action-addon-linter@v2
        with:
          path: "./${{ github.event.inputs.addon }}"

      # If repository dispatch or schedule, we need detection logic (Future Implementation: Smart Add-on Detection)
      # For now, we assume this job runs for manual or specific events.

      - name: ‚ÑπÔ∏è Get Add-on Info
        id: info
        if: github.event_name == 'workflow_dispatch'
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ github.event.inputs.addon }}"

      - name: üèóÔ∏è Test Build (Manual)
        if: github.event_name == 'workflow_dispatch'
        uses: home-assistant/builder@2025.11.0
        with:
          args: |
            --test \
            --target /data/${{ github.event.inputs.addon }} \
            --image "${{ steps.info.outputs.image }}" \
            --docker-hub "ghcr.io/${{ github.repository_owner }}" \
            --addon

  # --------------------------------------------------------------------------------
  # RELEASE: Build & Push
  # --------------------------------------------------------------------------------
  release:
    name: üöÄ Release ${{ github.event.inputs.addon || 'Automated' }}
    needs: verify
    runs-on: ubuntu-latest
    # Manual release permissions needs
    permissions:
      contents: write
      packages: write
    steps:
      - name: ‚§µÔ∏è Check out code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: ‚ÑπÔ∏è Get Add-on Info
        id: info
        if: github.event_name == 'workflow_dispatch'
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ github.event.inputs.addon }}"

      - name: üêã Login to GitHub Container Registry
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üèóÔ∏è Build & Push Add-on
        if: github.event_name == 'workflow_dispatch'
        uses: home-assistant/builder@2025.11.0
        with:
          args: |
            --aarch64 \
            --amd64 \
            --target /data/${{ github.event.inputs.addon }} \
            --image "${{ steps.info.outputs.image }}" \
            --docker-hub "ghcr.io/${{ github.repository_owner }}" \
            --addon \
            --no-cache

      # Future: Changelog updates, tagging, etc.
      # For now, base build handles tagging via version in config.yaml?
      # Actually, typically we bump config.yaml version first.
      # This orchestrator implies we should execute a bump first if it's not done.
      # For Phase 1, we assume the builder handles image pushing based on current config version
      # OR the user handles the version bump.
      # The Requirement "Input: version_increment" suggests WE should bump it.

      - name: ‚¨ÜÔ∏è Bump Version & Changelog
        if: github.event_name == 'workflow_dispatch'
        run: |
          python3 .scripts/bump_version.py "${{ github.event.inputs.addon }}" "${{ github.event.inputs.version }}" --message "Manual Release via Orchestrator"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üöÄ Commit Version Bump
        if: github.event_name == 'workflow_dispatch'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: release ${{ github.event.inputs.addon }} version bump [skip ci]"
          file_pattern: "${{ github.event.inputs.addon }}/*"
