name: Orchestrator Release

on:
  workflow_dispatch:
    inputs:
      addon:
        description: "Add-on slug (folder name)"
        required: true
        type: string
      version:
        description: "Version increment (major, minor, patch)"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
  repository_dispatch:
    types: [dependency-update, base-image-update]
  schedule:
    - cron: "0 5 1 * *" # Monthly Edge Updates

permissions:
  contents: write
  packages: write
  actions: write

jobs:
  # --------------------------------------------------------------------------------
  # SCHEDULE: Monthly Edge Updates
  # --------------------------------------------------------------------------------
  schedule-edge:
    name: üóìÔ∏è Monthly Edge Trigger
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Check out code
        uses: actions/checkout@v4

      - name: üöÄ Run Trigger Script
        run: python3 .scripts/trigger_edge_updates.py
        env:
          GITHUB_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

  # --------------------------------------------------------------------------------
  # VERIFY: Functional Check Before Release
  # --------------------------------------------------------------------------------
  verify:
    name: ‚úÖ Verify ${{ github.event.inputs.addon || 'Automated' }}
    # needs: [] # Independent verification
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Check out code
        uses: actions/checkout@v4

      # If manual dispatch, verify the specific add-on
      - name: üïµÔ∏è Add-on Linter (Manual)
        if: github.event_name == 'workflow_dispatch'
        uses: frenck/action-addon-linter@f995494fd84fae6310d23617e66d0e37de4f14eb # v2.21.0
        with:
          path: "./${{ github.event.inputs.addon }}"

      # If repository dispatch or schedule, we need detection logic (Future Implementation: Smart Add-on Detection)
      # For now, we assume this job runs for manual or specific events.

      - name: ‚ÑπÔ∏è Get Add-on Info
        id: info
        if: github.event_name == 'workflow_dispatch'
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ github.event.inputs.addon }}"

      - name: üèóÔ∏è Test Build (Manual)
        if: github.event_name == 'workflow_dispatch'
        uses: home-assistant/builder@2025.11.0
        with:
          args: |
            --test \
            --target /data/${{ github.event.inputs.addon }} \
            --image "${{ steps.info.outputs.image }}" \
            --docker-hub "ghcr.io/${{ github.repository_owner }}" \
            --addon \
            --docker-args "--build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

  # --------------------------------------------------------------------------------
  # RELEASE: Build & Push
  # --------------------------------------------------------------------------------
  release:
    name: üöÄ Release ${{ github.event.inputs.addon || 'Automated' }}
    needs: verify
    # Run for repository_dispatch/schedule (verify skipped), or after verify passes for manual dispatch
    if: |
      always() &&
      (github.event_name == 'repository_dispatch' ||
       (github.event_name == 'workflow_dispatch' && (needs.verify.result == 'success' || needs.verify.result == 'skipped')))
    runs-on: ubuntu-latest
    # Manual release permissions needs
    steps:
      - name: ‚§µÔ∏è Check out code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: üõë Fail if no addon
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'
        run: |
          ADDON="${{ github.event.inputs.addon || github.event.client_payload.addon }}"
          if [ -z "$ADDON" ]; then
            echo "::error::No add-on specified for release!"
            exit 1
          fi

      - name: ‚ÑπÔ∏è Get Add-on Info
        id: info
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ github.event.inputs.addon || github.event.client_payload.addon }}"

      - name: üêã Login to GitHub Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚¨ÜÔ∏è Bump Version & Changelog
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'
        run: |
          python3 .scripts/bump_version.py "${{ github.event.inputs.addon || github.event.client_payload.addon }}" "${{ github.event.inputs.version || github.event.client_payload.version }}" --message "Manual Release via Orchestrator"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üöÄ Commit Version Bump
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'
        uses: stefanzweifel/git-auto-commit-action@e348103e9026cc0eee72ae06630dbe30c8bf7a79 # v5.1.0
        with:
          commit_message: "chore: release ${{ github.event.inputs.addon || github.event.client_payload.addon }} version bump [skip ci]"
          file_pattern: "${{ github.event.inputs.addon || github.event.client_payload.addon }}/*"

      - name: üèóÔ∏è Build & Push Add-on
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'
        uses: home-assistant/builder@2025.11.0
        with:
          args: |
            --aarch64 \
            --amd64 \
            --target /data/${{ github.event.inputs.addon || github.event.client_payload.addon }} \
            --image "${{ steps.info.outputs.image }}" \
            --docker-hub "ghcr.io/${{ github.repository_owner }}" \
            --addon \
            --docker-args "--build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --no-cache
