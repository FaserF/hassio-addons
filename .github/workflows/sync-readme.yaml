---
name: Sync README App List

on:
  push:
    branches:
      - main
      - master
    paths:
      - "**/config.yaml"
      - ".unsupported/**/config.yaml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-readme:
    name: Sync Apps List
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Check out code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: üêç Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      - name: üì¶ Install dependencies
        run: pip install pyyaml

      - name: üìù Generate App table
        id: generate
        run: |
          python3 << 'EOF'
          import os
          import yaml
          from pathlib import Path

          def parse_version(version_str):
              try:
                  parts = str(version_str).lstrip("v").split(".")
                  return tuple(int(p) for p in parts[:3])
              except:
                  return (0, 0, 0)

          def get_status(version, is_unsupported):
              if is_unsupported:
                  return "‚ùå"
              major, _, _ = parse_version(version)
              return "‚úÖ" if major >= 1 else "‚ö†Ô∏è"

          repo_root = Path(".")
          Apps = []

          # Regular Apps
          for item in sorted(repo_root.iterdir()):
              if item.is_dir() and not item.name.startswith((".", "_")):
                  config = item / "config.yaml"
                  if config.exists():
                      Apps.append({"path": item.name, "config": config, "unsupported": False})

          # Unsupported Apps
          unsupported = repo_root / ".unsupported"
          if unsupported.exists():
              for item in sorted(unsupported.iterdir()):
                  if item.is_dir():
                      config = item / "config.yaml"
                      if config.exists():
                          Apps.append({"path": f".unsupported/{item.name}", "config": config, "unsupported": True})

          # Generate table
          lines = [
              "| Name                                                            | Description                               | Status | Added |",
              "| :-------------------------------------------------------------- | :---------------------------------------- | :----- | :---- |"
          ]

          import subprocess
          for App in Apps:
              with open(App["config"], "r") as f:
                  cfg = yaml.safe_load(f)
              name = cfg.get("name", App["path"])
              desc = cfg.get("description", "No description")[:40]
              if App["unsupported"]:
                  desc = f"{desc} (Unsupported)"[:40]
              version = str(cfg.get("version", "0.0.0"))
              status = get_status(version, App["unsupported"])

              # Get first commit date
              # For unsupported Apps, try to find the original creation date
              # by checking the original path before it was moved to .unsupported
              try:
                  config_path = str(App["config"])

                  # If unsupported, try original path first
                  if App["unsupported"]:
                      # Extract App name from path (e.g., ".unsupported/bt-mqtt-gateway" -> "bt-mqtt-gateway")
                      App_name = Path(App["config"]).parent.name
                      original_config = repo_root / App_name / "config.yaml"

                      # Try to get date from original location
                      try:
                          result = subprocess.run(
                              ["git", "log", "--follow", "--format=%cs", "--", str(original_config)],
                              capture_output=True, text=True, check=True
                          )
                          dates = result.stdout.strip().split("\n")
                          if dates and dates[-1]:
                              since = dates[-1][:7]
                          else:
                              raise Exception("No dates found")
                      except:
                          # Fallback to current location if original path doesn't exist in history
                          result = subprocess.run(
                              ["git", "log", "--follow", "--format=%cs", "--", config_path],
                              capture_output=True, text=True, check=True
                          )
                          dates = result.stdout.strip().split("\n")
                          since = dates[-1][:7] if dates and dates[-1] else "‚Äî"
                  else:
                      # Regular App - use current path
                      result = subprocess.run(
                          ["git", "log", "--follow", "--format=%cs", "--", config_path],
                          capture_output=True, text=True, check=True
                      )
                      dates = result.stdout.strip().split("\n")
                      since = dates[-1][:7] if dates and dates[-1] else "‚Äî"
              except:
                  since = "‚Äî"

              lines.append(f"| **[{name}]({App['path']})** | {desc} | {status} | {since} |")
