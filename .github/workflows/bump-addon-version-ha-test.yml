name: Bump Addon Version (HA Test Instance)

on:
  schedule:
    - cron: '0 4 * * *' # Run daily at 4 AM
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Determine latest version
        id: version
        shell: python
        run: |
          import subprocess
          import sys
          subprocess.check_call([sys.executable, "-m", "pip", "install", "packaging"])
          import json
          import urllib.request
          import os
          from packaging.version import parse

          def get_version(url, channel):
              try:
                  with urllib.request.urlopen(url) as response:
                      data = json.loads(response.read().decode())
                      return conversation_version(data['homeassistant']['default'])
              except Exception as e:
                  print(f"Error fetching {channel}: {e}")
                  return None

          def conversation_version(v_str):
               # Simple wrapper
               return v_str

          stable_ver = get_version("https://version.home-assistant.io/stable.json", "stable")
          beta_ver = get_version("https://version.home-assistant.io/beta.json", "beta")

          print(f"Stable: {stable_ver}")
          print(f"Beta: {beta_ver}")

          # Logic: Use Beta. If Stable is newer than Beta, use Stable.

          target_ver = beta_ver
          if stable_ver and beta_ver:
              if parse(stable_ver) > parse(beta_ver):
                  target_ver = stable_ver
          elif stable_ver and not beta_ver:
               target_ver = stable_ver
          elif not stable_ver and not beta_ver:
               print("Error: Could not fetch any version.")
               sys.exit(1)

          print(f"Target HA Version: {target_ver}")

          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
              print(f"target_version={target_ver}", file=fh)

      - name: Check and Update files
        id: update
        run: |
          TARGET_HA_VERSION="${{ steps.version.outputs.target_version }}"
          ADDON_DIR="homeassistant-test-instance"
          CONFIG_FILE="$ADDON_DIR/config.yaml"
          DOCKER_FILE="$ADDON_DIR/Dockerfile"
          CHANGELOG_FILE="$ADDON_DIR/CHANGELOG.md"

          if [ -z "$TARGET_HA_VERSION" ]; then
            echo "Error: extracted target version is empty."
            exit 1
          fi

          echo "Target HA Version: $TARGET_HA_VERSION"

          # Get current HA version from Dockerfile ARG (fallback to checking config if arg missing or different)
          CURRENT_HA_VERSION=$(grep -E '^ARG HA_VERSION=' "$DOCKER_FILE" | cut -d= -f2)
          echo "Current HA Version in Dockerfile: $CURRENT_HA_VERSION"

          if [ "$TARGET_HA_VERSION" != "$CURRENT_HA_VERSION" ]; then
            echo "HA Version mismatch! Updating..."

            # 1. Get current Addon Version
            CURRENT_ADDON_VERSION=$(grep -E '^version:' "$CONFIG_FILE" | awk '{print $2}' | tr -d '"')
            echo "Current Addon Version: $CURRENT_ADDON_VERSION"

            # 2. Bump Patch Version (Semantic)
            # Assuming semantic versioning X.Y.Z
            if [[ "$CURRENT_ADDON_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              MAJOR="${BASH_REMATCH[1]}"
              MINOR="${BASH_REMATCH[2]}"
              PATCH="${BASH_REMATCH[3]}"
              PATCH=$((PATCH + 1))
              NEW_ADDON_VERSION="$MAJOR.$MINOR.$PATCH"
            else
              echo "Warning: Could not parse current version semantically. Appending .1"
              NEW_ADDON_VERSION="${CURRENT_ADDON_VERSION}.1"
            fi
            echo "New Addon Version: $NEW_ADDON_VERSION"

            # 3. Update config.yaml
            sed -i "s/^version: .*/version: \"$NEW_ADDON_VERSION\"/" "$CONFIG_FILE"

            # 4. Update Dockerfile
            sed -i "s/^ARG HA_VERSION=.*/ARG HA_VERSION=$TARGET_HA_VERSION/" "$DOCKER_FILE"

            # 5. Update CHANGELOG.md
            # Create a temporary file for the new changelog entry
            TEMP_HEADER=$(mktemp)
            echo -e "## $NEW_ADDON_VERSION\n\n- Update Home Assistant to version $TARGET_HA_VERSION\n" > "$TEMP_HEADER"

            # Insert after the # Changelog line? Or just top if no header?
            # Standard: # Changelog\n\n## Version...

            if grep -q "^# Changelog" "$CHANGELOG_FILE"; then
              # Insert after line 1 (assuming line 1 is # Changelog)
              # Using sed to read in the temp file after line 1
              sed -i "1r $TEMP_HEADER" "$CHANGELOG_FILE"
            else
              # Prepend header and entry
              echo "# Changelog" > "temp_changelog_full"
              echo "" >> "temp_changelog_full"
              cat "$TEMP_HEADER" >> "temp_changelog_full"
              cat "$CHANGELOG_FILE" >> "temp_changelog_full"
              mv "temp_changelog_full" "$CHANGELOG_FILE"
            fi

            echo "updated=true" >> $GITHUB_OUTPUT
            echo "version=$NEW_ADDON_VERSION" >> $GITHUB_OUTPUT
          else
            echo "Version is up to date."
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push
        if: steps.update.outputs.updated == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Bumps Home Assistant Test Instance to ${{ steps.update.outputs.version }}"
          branch: master
          file_pattern: homeassistant-test-instance/config.yaml homeassistant-test-instance/Dockerfile homeassistant-test-instance/CHANGELOG.md
