name: Orchestrator Edge Sync

# This workflow keeps the 'edge' branch in sync with 'master'
# and prepares it for local development builds (removes image tags)

on:
  push:
    branches:
      - master
    paths-ignore:
      - ".unsupported/**"
  workflow_dispatch:
    inputs:
      force_sync:
        description: "Force sync edge branch"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  sync-edge:
    name: ðŸ”„ Sync Edge Branch
    runs-on: ubuntu-latest
    steps:
      - name: â¤µï¸ Checkout master
        uses: actions/checkout@v6
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸŒ¿ Reset edge branch to master
        run: |
          echo "Resetting edge branch to match master..."
          git checkout -B edge master

      - name: ðŸ—‘ï¸ Remove Unsupported Addons
        run: |
          echo "Removing .unsupported directory from edge branch..."
          rm -rf .unsupported
          git add .unsupported
          git commit -m "chore: remove unsupported addons from edge [skip ci]" || echo "No unsupported addons to remove"

      - name: ðŸ“ Prepare edge for local builds
        run: |
          pip install pyyaml --quiet
          python3 .scripts/prepare_edge_branch.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”„ Update version to dev
        run: |
          # Bump all supported addon versions to dev
          for config in */config.yaml; do
            if [ -f "$config" ]; then
              ADDON_DIR=$(dirname "$config")
              # Skip .unsupported directory entry if it somehow exists
              if [[ "$ADDON_DIR" != "." ]] && [[ ! "$ADDON_DIR" =~ ^\. ]]; then
                echo "Processing $ADDON_DIR..."
                python3 .scripts/bump_version.py "$ADDON_DIR" patch --dev --changelog 2>/dev/null || echo "Skipping $ADDON_DIR"
              fi
            fi
          done

      - name: ðŸš€ Push edge branch
        run: |
          git add -A
          git diff --staged --quiet || git commit -m "chore: prepare edge branch for local builds [skip ci]"
          git push origin edge --force
