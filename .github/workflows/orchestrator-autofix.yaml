name: Orchestrator Auto-Fix

permissions:
  contents: write
  pull-requests: write
  actions: write

on:
  push:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  autofix:
    if: >-
      !contains((github.event.head_commit.message || ''), 'style: auto-fix') &&
      !contains((github.event.head_commit.message || ''), '[skip-tests]') &&
      github.actor != 'git-auto-commit-action' &&
      github.actor != 'github-actions[bot]' &&
      github.actor != 'coderabbitai[bot]'
    name: üîß Auto-Fix & Format
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Check out code
        # zizmor: ignore[artipacked]
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: üêç Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - name: üì¶ Install Python Deps
        run: pip install pyyaml

      - name: üè∑Ô∏è Auto-Generate OCI Labels
        continue-on-error: true
        run: python3 .scripts/fix_oci_labels.py

      - name: ‚ö†Ô∏è Update Unsupported Status
        continue-on-error: true
        run: python3 .scripts/update_unsupported_status.py

      - name: üè∑Ô∏è Update README Beta Status
        continue-on-error: true
        run: python3 .scripts/update_readme_status.py

      - name: üõ°Ô∏è Enforce 64-bit Architectures
        id: enforce_arch
        run: python3 .scripts/enforce_architectures.py

      # COMMENTED OUT: This step requires pull_request trigger which was removed.
      # Keep for future reference if PR autofix is re-enabled.
      # - name: üí¨ Comment on PR (32-bit Removal)
      #   if: github.event_name == 'pull_request' && steps.enforce_arch.outputs.modified == 'true'
      #   uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      #   with:
      #     script: |
      #       const signature = "<!-- autofix-32bit-notice -->";
      #
      #       const { data: comments } = await github.rest.issues.listComments({
      #          owner: context.repo.owner,
      #          repo: context.repo.repo,
      #          issue_number: context.issue.number,
      #       });
      #
      #       const previousComments = comments.filter(c => c.user.type === 'Bot' && (c.body.includes(signature) || c.body.includes("**Notice:** 32-bit architectures")));
      #
      #       for (const comment of previousComments) {
      #           try {
      #               await github.graphql(`
      #                   mutation($subjectId: ID!) {
      #                       minimizeComment(input: {subjectId: $subjectId, classifier: OUTDATED}) {
      #                           minimizedComment { isMinimized }
      #                       }
      #                   }
      #               `, { subjectId: comment.node_id });
      #           } catch (error) {
      #               console.error(`Failed to minimize comment ${comment.id}:`, error);
      #           }
      #       }
      #
      #       await github.rest.issues.createComment({
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: signature + '\n‚ö†Ô∏è **Notice:** 32-bit architectures (armhf, armv7, i386) have been automatically removed from this PR. These architectures are no longer supported by Home Assistant or this repository.'
      #       })

      - name: üèÅ Renormalize Line Endings
        run: git add --renormalize .

      # 1. Shell Scripts (Format)
      - name: üêö Setup shfmt
        uses: mfinelli/setup-shfmt@v4
        with:
          shfmt-version: "3.12.0"

      - name: üêö Run shfmt
        id: shfmt
        run: |
          shfmt -l -w .
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      # 2. Python (Format & Sort Imports)
      # We format the internal scripts and any add-on python files
      - name: üêç Run Black (Formatter)
        id: black
        continue-on-error: true
        run: |
          pip install black
          black --verbose .
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: üêç Run Isort (Import Sorter)
        id: isort
        run: |
          pip install isort
          isort --profile black .
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      # 3. Node.js Tools (Prettier, Markdownlint)
      - name: üì¶ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: üíÖ Run Prettier
        id: prettier
        continue-on-error: true
        run: |
          npm install -g prettier
          # Use prettier with explicit patterns to ensure all files are found
          # The --write flag formats files in place
          prettier --write "**/*.{json,js,md,yaml,yml}" --ignore-path .prettierignore --log-level=warn
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      # 4. Standardize (READMEs, Beta Labels, Configs)
      - name: üìÑ Standardize READMEs
        run: python3 .scripts/standardize_readmes.py

      # 5. Markdown Fixes (markdownlint)
      - name: üìù Fix Markdown
        id: markdownlint
        continue-on-error: true
        run: |
          npm install -g markdownlint-cli
          markdownlint --fix "**/*.md" || true
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      # 6. Remove Trailing Spaces
      - name: üßπ Remove Trailing Spaces
        run: |
          find .github/workflows -name "*.yaml" -type f -exec sed -i 's/[[:space:]]*$//' {} +

      # 7. Clean Excessive Blank Lines
      - name: üßπ Clean Excessive Blank Lines
        run: |
          python3 .scripts/clean_blank_lines.py
      # 8. Bump Test Script Version
      - name: üÜô Bump Test Script Version
        continue-on-error: true
        run: python3 .scripts/bump_script_version.py

      # Build dynamic commit message
      - name: üìù Build Commit Message
        id: commit_msg
        run: |
          tools=""
          if [[ "${{ steps.shfmt.outputs.changed }}" == "true" ]]; then tools="$tools shfmt"; fi
          if [[ "${{ steps.black.outputs.changed }}" == "true" ]]; then tools="$tools black"; fi
          if [[ "${{ steps.isort.outputs.changed }}" == "true" ]]; then tools="$tools isort"; fi
          if [[ "${{ steps.prettier.outputs.changed }}" == "true" ]]; then tools="$tools prettier"; fi
          if [[ "${{ steps.markdownlint.outputs.changed }}" == "true" ]]; then tools="$tools markdownlint"; fi

          tools=$(echo "$tools" | xargs | tr ' ' ', ')

          if [[ -z "$tools" ]]; then
            echo "message=style: auto-fix" >> "$GITHUB_OUTPUT"
          else
            echo "message=style: auto-fix ($tools)" >> "$GITHUB_OUTPUT"
          fi

      # Exclude workflow files from auto-commit (GitHub Apps require special permission to modify workflows)
      - name: üö´ Unstage Workflow Files
        run: |
          # Remove workflow files from staging area (keeps formatted changes in working directory)
          git reset HEAD .github/workflows/*.yaml 2>/dev/null || true
          git restore --staged .github/workflows/*.yaml 2>/dev/null || true
          # Verify they are not staged
          if git diff --cached --name-only | grep -q "\.github/workflows/"; then
            echo "Warning: Some workflow files are still staged, removing them..."
            git diff --cached --name-only | grep "\.github/workflows/" | xargs -r git reset HEAD || true
          fi
          echo "Workflow files removed from staging area"

      # Commit back (using PAT to trigger subsequent workflows)
      # git-auto-commit-action will add all changed files matching file_pattern
      # We need to ensure workflow files are not in the commit
      - name: üíæ Commit Changes
        id: commit_changes
        continue-on-error: true
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: ${{ steps.commit_msg.outputs.message }}
          branch: ${{ github.ref_name }}
          file_pattern: .
        env:
          # Use PAT to trigger subsequent workflows; fallback to GITHUB_TOKEN
          GITHUB_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      # If commit failed due to workflow files, remove them and commit again
      - name: üîÑ Fix Push & Retry
        if: steps.commit_changes.outcome == 'failure'
        run: |
          echo "Previous commit/push failed. Attempting to recover..."

          # 1. Fetch latest
          git fetch origin ${{ github.ref_name }}

          # 2. Rebase on top of upstream to resolve non-fast-forward
          echo "Rebasing on top of origin/${{ github.ref_name }}..."
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          # Explicitly set rebase strategy to avoid issues
          if ! git pull --rebase origin ${{ github.ref_name }}; then
            echo "Rebase failed. Conflict likely. Aborting."
            exit 1
          fi

          # 3. Safety check: Ensure no workflow files are in the commit
          # (This handles the case where workflow files might have slipped in)
          if git diff-tree --no-commit-id --name-only -r HEAD | grep -q "\.github/workflows/"; then
             echo "Detected workflow files in commit. Removing them..."
             git reset --soft HEAD~1
             git reset HEAD .github/workflows/*.yaml
             git commit -m "${{ steps.commit_msg.outputs.message }}"
          fi

          # 4. Push
          echo "Pushing changes..."
          git push origin ${{ github.ref_name }}
