name: Orchestrator Updates

on:
  push:
    branches:
      - master
    paths:
      - "**/Dockerfile"
      - "**/build.yaml"

jobs:
  auto-bump:
    name: üîÑ Auto-Bump & Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: ‚§µÔ∏è Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Needed for git diff

      - name: üïµÔ∏è Detect & Bump
        id: bump
        run: |
          python3 .scripts/auto_update.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üöÄ Commit Version Bump
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-bump version [skip ci]"
          file_pattern: "**/config.yaml **/CHANGELOG.md"

      # We cannot easily trigger a reusable workflow in a matrix from a dynamic output in the same job
      # without a complicated setup (Json parsing, separate job).
      # For Phase 4, simpler approach: If bumped, we can trigger the release via repository_dispatch or just run the release logic here.
      # Or we rely on `orchestrator-release` supporting `workflow_dispatch` and we call it via gh cli.

      - name: üìû Trigger Release
        if: steps.bump.outputs.updated_addon != ''
        run: |
          # There might be multiple addons outputted? The script currently writes one line per addon?
          # Actually the script appends "updated_addon=..." which might result in multiple keys or multiline?
          # GITHUB_OUTPUT handles multiline string but `updated_addon=a` `updated_addon=b` overwrites.
          # I need to fix the script to output JSON or handle single trigger.
          # For now, let's assume one change per commit usually, or iterate.
          # Better: Trigger for the specific addon.
          # Using gh workflow run
          echo "Triggering release for ${{ steps.bump.outputs.updated_addon }}"
          gh workflow run orchestrator-release.yaml -f addon=${{ steps.bump.outputs.updated_addon }} -f version=patch
          # Version input is technically ignored if we already bumped it, but required by schema.
        env:
          GITHUB_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
