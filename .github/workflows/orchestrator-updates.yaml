name: Orchestrator Updates

on:
  schedule:
    - cron: "0 4 * * *" # Daily check (replacing HA Test Instance schedule)
  push:
    branches:
      - master
    paths:
      - "**/build.yaml" # Trigger on base image updates (replacing Bump-Addon-Version-base)
  workflow_dispatch:
    inputs:
      target:
        description: "Target Update (base/ha-test/specific)"
        required: true
        default: "base"
        type: choice
        options:
          - base
          - ha-test
          - all

permissions:
  contents: write

jobs:
  # --------------------------------------------------------------------------------
  # HA TEST INSTANCE UPDATE
  # --------------------------------------------------------------------------------
  update-ha-test:
    name: ðŸ”„ Update HA Test Instance
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.target == 'ha-test' || github.event.inputs.target == 'all'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.x"

      - name: Determine latest version
        id: version
        shell: python
        run: |
          import subprocess
          import sys
          subprocess.check_call([sys.executable, "-m", "pip", "install", "packaging"])
          import json
          import urllib.request
          import os
          from packaging.version import parse

          def get_version(url, channel):
              try:
                  with urllib.request.urlopen(url) as response:
                      data = json.loads(response.read().decode())
                      return data['homeassistant']['default']
              except Exception as e:
                  print(f"Error fetching {channel}: {e}")
                  return None

          stable_ver = get_version("https://version.home-assistant.io/stable.json", "stable")
          beta_ver = get_version("https://version.home-assistant.io/beta.json", "beta")

          print(f"Stable: {stable_ver}")
          print(f"Beta: {beta_ver}")

          target_ver = beta_ver
          if stable_ver and beta_ver:
              if parse(stable_ver) > parse(beta_ver):
                  target_ver = stable_ver
          elif stable_ver and not beta_ver:
               target_ver = stable_ver
          elif not stable_ver and not beta_ver:
               print("Error: Could not fetch any version.")
               sys.exit(1)

          print(f"Target HA Version: {target_ver}")
          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
              print(f"target_version={target_ver}", file=fh)

      - name: Check and Update files
        id: update
        run: |
          TARGET_HA_VERSION="${{ steps.version.outputs.target_version }}"
          ADDON_DIR="homeassistant-test-instance"
          CONFIG_FILE="$ADDON_DIR/config.yaml"
          DOCKER_FILE="$ADDON_DIR/Dockerfile"
          CHANGELOG_FILE="$ADDON_DIR/CHANGELOG.md"

          if [ -z "$TARGET_HA_VERSION" ]; then
            echo "Error: extracted target version is empty."
            exit 1
          fi

          CURRENT_HA_VERSION=$(grep -E '^ARG HA_VERSION=' "$DOCKER_FILE" | cut -d= -f2)

          if [ "$TARGET_HA_VERSION" != "$CURRENT_HA_VERSION" ]; then
            echo "HA Version mismatch! Updating..."
            CURRENT_ADDON_VERSION=$(grep -E '^version:' "$CONFIG_FILE" | awk '{print $2}' | tr -d '"')

            # Bump Patch
            if [[ "$CURRENT_ADDON_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              MAJOR="${BASH_REMATCH[1]}"
              MINOR="${BASH_REMATCH[2]}"
              PATCH="${BASH_REMATCH[3]}"
              PATCH=$((PATCH + 1))
              NEW_ADDON_VERSION="$MAJOR.$MINOR.$PATCH"
            else
              NEW_ADDON_VERSION="${CURRENT_ADDON_VERSION}.1"
            fi

            sed -i "s/^version: .*/version: \"$NEW_ADDON_VERSION\"/" "$CONFIG_FILE"
            sed -i "s/^ARG HA_VERSION=.*/ARG HA_VERSION=$TARGET_HA_VERSION/" "$DOCKER_FILE"

            # Simple Changelog prepend
            TEMP_HEADER=$(mktemp)
            echo -e "## $NEW_ADDON_VERSION\n\n- Update Home Assistant to version $TARGET_HA_VERSION\n" > "$TEMP_HEADER"

            if grep -q "^# Changelog" "$CHANGELOG_FILE"; then
               sed -i "1r $TEMP_HEADER" "$CHANGELOG_FILE"
            else
                {
                  echo "# Changelog"
                  echo ""
                  cat "$TEMP_HEADER"
                  cat "$CHANGELOG_FILE"
                } > "temp_changelog_full"
                mv "temp_changelog_full" "$CHANGELOG_FILE"
            fi

            {
              echo "updated=true"
              echo "version=$NEW_ADDON_VERSION"
            } >> "$GITHUB_OUTPUT"
          else
            echo "updated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and Push
        if: steps.update.outputs.updated == 'true'
        uses: stefanzweifel/git-auto-commit-action@b863ae1933cb653a53c021fe36dbb774e1fb9403 # v5.2.0
        with:
          commit_message: "Bumps Home Assistant Test Instance to ${{ steps.update.outputs.version }}"
          file_pattern: homeassistant-test-instance/*

      - name: ðŸ“¨ Trigger Release Build
        if: steps.update.outputs.updated == 'true'
        uses: peter-evans/repository-dispatch@28959ce8df70de7be546dd1250a005dd32156697 # v4.0.1
        with:
          event-type: dependency-update
          client-payload: '{"addon": "homeassistant-test-instance", "version": "patch"}'

  # --------------------------------------------------------------------------------
  # BASE IMAGE UPDATES (Generic)
  # --------------------------------------------------------------------------------
  update-base-images:
    name: ðŸ”„ Update Base Images
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.target == 'base' || github.event.inputs.target == 'all'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: "Retrieve version & increment it"
        run: |
          echo "Running Base Image Update Logic..."

      - name: Call Update Script
        run: bash .scripts/update_base_images.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
