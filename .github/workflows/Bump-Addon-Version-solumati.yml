name: Automatically bump version and build Solumati

permissions:
  contents: write
  packages: write

"on":
  push:
    branches:
      - master
    paths:
      - 'solumati/Dockerfile'
  workflow_dispatch:

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      addon: "solumati"
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Retrieve version & increment
        id: version
        run: |
          set -e
          configfile="solumati/config.yaml"
          # Extract version
          OLD_VERSION=$(grep -E '^[[:space:]]*version:[[:space:]]+' "$configfile" | head -1 | awk '{print $2}' | tr -d '"')

          # Increment patch version
          IFS='.' read -r major minor patch build <<< "$OLD_VERSION"
          if [[ -z "$build" ]]; then
             ((patch++))
             NEW_VERSION="$major.$minor.$patch"
          else
             ((build++))
             NEW_VERSION="$major.$minor.$patch.$build"
          fi

          echo "Updating $configfile from $OLD_VERSION to $NEW_VERSION"
          sed -i "s/^version: \"\?$OLD_VERSION\"\?/version: \"$NEW_VERSION\"/" "$configfile"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update Changelog & Dockerfile
        run: |
          repo_url="https://api.github.com/repos/FaserF/Solumati"
          # IMPORTANT: Use 'releases' instead of 'releases/latest' to include pre-releases!
          response=$(curl -s "$repo_url/releases?per_page=1")
          # Use jq for safer parsing
          latest_tag=$(echo "$response" | jq -r '.[0].tag_name')

          if [ -z "$latest_tag" ] || [ "$latest_tag" == "null" ]; then
            echo "Error: Could not retrieve tag from GitHub."
            exit 1
          fi

          echo "Latest tag found: $latest_tag"

          # 1. Changelog Update
          changelog="solumati/CHANGELOG.md"
          new_ver="${{ steps.version.outputs.new_version }}"

          if [ -f "$changelog" ]; then
              sed -i "/# Changelog/a \\\\n## $new_ver\\n- Automatically updated Solumati to version $latest_tag\\n" "$changelog"
          fi

          # 2. Dockerfile Update
          dockerfile="solumati/Dockerfile"
          if [ -f "$dockerfile" ]; then
              echo "Updating Dockerfile to version $latest_tag..."
              # Replaces ARG SOLUMATI_VERSION="old" with ARG SOLUMATI_VERSION="new"
              sed -i "s/ARG SOLUMATI_VERSION=\".*\"/ARG SOLUMATI_VERSION=\"$latest_tag\"/" "$dockerfile"
          else
              echo "Error: Dockerfile not found!"
              exit 1
          fi

      - name: Upload Config Artifact
        uses: actions/upload-artifact@v6
        with:
          name: addon-config
          path: solumati/

  build:
    needs: version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: ["aarch64", "amd64"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download Config Artifact
        uses: actions/download-artifact@v7
        with:
          name: addon-config
          path: solumati/

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        uses: home-assistant/builder@2025.11.0
        with:
          args: |
            --${{ matrix.arch }} \
            --target solumati \
            --image "solumati-{arch}" \
            --docker-hub "ghcr.io/${{ github.repository_owner }}" \
            --addon

  commit:
    needs: [version, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: master

      - name: Download Config Artifact
        uses: actions/download-artifact@v7
        with:
          name: addon-config
          path: solumati/

      - name: Commit & Push
        uses: actions-js/push@v1.5
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: master
          message: "Bump Solumati version to ${{ needs.version.outputs.new_version }} [skip ci]"