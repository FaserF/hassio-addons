name: Trigger All Releases

# This workflow triggers releases for all add-ons
# Can be triggered manually or via commit message

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version increment (major, minor, patch)"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      skip_verification:
        description: "Skip lint/build verification"
        required: false
        default: false
        type: boolean
      changelog_only:
        description: "Only update changelog, don't bump version (versions already correct)"
        required: false
        default: true
        type: boolean

  push:
    branches:
      - master
    paths:
      - ".github/workflows/trigger-all-releases.yaml"
    # Also trigger on special commit message
    # Usage: git commit -m "üöÄ release(all): trigger all releases"

permissions:
  contents: read
  actions: write

jobs:
  trigger-releases:
    name: üöÄ Trigger All Releases
    runs-on: ubuntu-latest
    # Only run if manually triggered or commit message contains "release(all)"
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'release(all)'))
    steps:
      - name: ‚§µÔ∏è Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: üîç Find all add-ons
        id: find-addons
        run: |
          ADDONS=""
          SKIP_ADDONS="homeassistant-test-instance"
          
          # Regular addons (top-level directories with config.yaml)
          for item in */; do
            item_name="${item%/}"
            if [ -f "${item}config.yaml" ] && [ ! "${item_name#.}" != "$item_name" ] && [ ! "${item_name#_}" != "$item_name" ]; then
              # Skip test add-ons
              skip=false
              for skip_item in $SKIP_ADDONS; do
                if [ "$item_name" == "$skip_item" ]; then
                  skip=true
                  break
                fi
              done
              if [ "$skip" == "false" ]; then
                [ -z "$ADDONS" ] && ADDONS="$item_name" || ADDONS="$ADDONS,$item_name"
              fi
            fi
          done
          
          # Unsupported addons
          if [ -d ".unsupported" ]; then
            for item in .unsupported/*/; do
              if [ -f "${item}config.yaml" ]; then
                item_name=".unsupported/$(basename "$item")"
                [ -z "$ADDONS" ] && ADDONS="$item_name" || ADDONS="$ADDONS,$item_name"
              fi
            done
          fi
          
          # Convert to JSON array
          if [ -n "$ADDONS" ]; then
            JSON="$(echo "$ADDONS" | tr ',' '\n' | jq -R . | jq -s .)"
          else
            JSON="[]"
          fi
          
          echo "addons=$JSON" >> "$GITHUB_OUTPUT"
          echo "üì¶ Found add-ons: $ADDONS"
          echo "Count: $(echo "$ADDONS" | tr ',' '\n' | wc -l)"

      - name: üöÄ Trigger Release Workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.event.inputs.version || 'patch' }}"
          SKIP_VERIFY="${{ github.event.inputs.skip_verification || 'false' }}"
          CHANGELOG_ONLY="${{ github.event.inputs.changelog_only || 'true' }}"
          
          ADDONS_JSON='${{ steps.find-addons.outputs.addons }}'
          ADDONS=$(echo "$ADDONS_JSON" | jq -r '.[]')
          
          echo "üöÄ Triggering releases for all add-ons..."
          echo "Version increment: $VERSION"
          echo "Skip verification: $SKIP_VERIFY"
          echo "Changelog only (no version bump): $CHANGELOG_ONLY"
          
          SUCCESS=0
          FAILED=0
          
          for addon in $ADDONS; do
            echo ""
            echo "üëâ Triggering release for: $addon"
            
            # Build workflow run command
            CMD_ARGS=(
              "gh" "workflow" "run" "orchestrator-release.yaml"
              "-f" "addon=$addon"
              "-f" "version=$VERSION"
            )
            
            if [ "$SKIP_VERIFY" == "true" ]; then
              CMD_ARGS+=("-f" "skip_verification=true")
            fi
            
            if [ "$CHANGELOG_ONLY" == "true" ]; then
              CMD_ARGS+=("-f" "changelog_only=true")
            fi
            
            "${CMD_ARGS[@]}" || {
              echo "‚ùå Failed to trigger $addon"
              FAILED=$((FAILED + 1))
              continue
            }
            
            SUCCESS=$((SUCCESS + 1))
            echo "‚úÖ Successfully triggered $addon"
            
            # Small delay to avoid rate limiting
            sleep 2
          done
          
          echo ""
          echo "üìä Summary:"
          echo "  ‚úÖ Successfully triggered: $SUCCESS"
          echo "  ‚ùå Failed: $FAILED"
          
          if [ $FAILED -gt 0 ]; then
            exit 1
          fi
