# Supervisor Integration Test Workflow
# Runs real Home Assistant Supervisor environment to test add-on installation, startup, and ingress
#
# This workflow is called by the main CI orchestrator (orchestrator-ci.yaml)
# It only runs when:
# - A PR has relevant code changes (not just documentation)
# - The add-on has ingress enabled
#
# Uses the official HA devcontainer with full Supervisor support

name: "üß™ Supervisor Integration Test"

on:
  workflow_call:
    inputs:
      addons:
        description: "Add-ons to test (JSON array of addon names)"
        required: true
        type: string
      timeout:
        description: "Timeout per add-on in minutes"
        required: false
        default: "15"
        type: string
  workflow_dispatch:
    inputs:
      addons:
        description: "Add-ons to test (comma-separated slugs, or 'ingress' for all ingress-enabled)"
        required: true
        default: "whatsapp"
        type: string
      timeout:
        description: "Timeout per add-on in minutes"
        required: false
        default: "15"
        type: string

concurrency:
  group: supervisor-test-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  DEVCONTAINER_IMAGE: ghcr.io/home-assistant/devcontainer:addons
  HA_PORT: 7123
  SUPERVISOR_STARTUP_TIMEOUT: 100
  ADDON_INSTALL_TIMEOUT: 300
  ADDON_START_TIMEOUT: 600

jobs:
  # Filter to only ingress-enabled addons
  filter-ingress:
    name: "üîç Filter Ingress Add-ons"
    runs-on: ubuntu-latest
    outputs:
      ingress_addons: ${{ steps.filter.outputs.ingress_addons }}
      has_addons: ${{ steps.filter.outputs.has_addons }}
    steps:
      - name: "üì• Checkout Repository"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "üîß Filter Ingress-Enabled Add-ons"
        id: filter
        run: |
          # shellcheck disable=SC2086,SC2129
          # Parse input - handle both JSON array (from workflow_call) and comma-separated (from dispatch)
          INPUT='${{ inputs.addons }}'

          # Check if it's a JSON array
          if echo "$INPUT" | jq -e 'type == "array"' > /dev/null 2>&1; then
            ADDONS=$(echo "$INPUT" | jq -r '.[]')
          elif [ "$INPUT" = "ingress" ]; then
            # Find all add-ons with ingress: true
            ADDONS=""
            while IFS= read -r config_file; do
              addon_dir=$(dirname "$config_file")
              addon_name=$(basename "$addon_dir")
              if [ "$addon_name" != "homeassistant-test-instance" ] && [ "$addon_name" != ".unsupported" ]; then
                ADDONS="${ADDONS}${addon_name}"$'\n'
              fi
            done < <(find . -maxdepth 2 -name "config.yaml" -exec grep -l "^ingress: true" {} +)
          else
            # Comma-separated list
            ADDONS=$(echo "$INPUT" | tr ',' '\n')
          fi

          echo "Input addons:"
          echo "$ADDONS"

          # Filter to only ingress-enabled addons
          INGRESS_ADDONS=""
          # shellcheck disable=SC2086
          for addon in $ADDONS; do
            addon=$(echo "$addon" | xargs)  # trim whitespace
            config_file=""

            if [ -f "./$addon/config.yaml" ]; then
              config_file="./$addon/config.yaml"
            elif [ -f "./.unsupported/$addon/config.yaml" ]; then
              echo "‚è≠Ô∏è $addon is unsupported - skipping"
              continue
            fi

            if [ -n "$config_file" ] && grep -q "^ingress: true" "$config_file" 2>/dev/null; then
              echo "‚úÖ $addon has ingress enabled"
              if [ -n "$INGRESS_ADDONS" ]; then
                INGRESS_ADDONS="$INGRESS_ADDONS,$addon"
              else
                INGRESS_ADDONS="$addon"
              fi
            else
              echo "‚è≠Ô∏è $addon does not have ingress - skipping"
            fi
          done

          if [ -z "$INGRESS_ADDONS" ]; then
            echo "No ingress-enabled add-ons to test"
            echo "ingress_addons=" >> "$GITHUB_OUTPUT"
            echo "has_addons=false" >> "$GITHUB_OUTPUT"
          else
            echo "Ingress add-ons to test: $INGRESS_ADDONS"
            echo "ingress_addons=$INGRESS_ADDONS" >> "$GITHUB_OUTPUT"
            echo "has_addons=true" >> "$GITHUB_OUTPUT"
          fi

  supervisor-test:
    name: "üè† Supervisor Test"
    needs: filter-ingress
    if: needs.filter-ingress.outputs.has_addons == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: "üì• Checkout Repository"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "üê≥ Set up Docker Buildx"
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: "üì¶ Pull Devcontainer Image"
        run: docker pull ${{ env.DEVCONTAINER_IMAGE }}

      - name: "üöÄ Start Supervisor Environment"
        id: supervisor
        run: |
          # shellcheck disable=SC2086,SC2129,SC2034
          # Create network
          docker network create ha-test-net 2>/dev/null || true

          # Create data directories
          mkdir -p /tmp/ha-data/addons/local
          mkdir -p /tmp/ha-data/config
          mkdir -p /tmp/ha-data/share
          mkdir -p /tmp/ha-data/ssl

          # Generate dummy SSL certs for universal support
          openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
            -subj "/C=US/ST=Denial/L=Springfield/O=Dis/CN=www.example.com" \
            -keyout /tmp/ha-data/ssl/privkey.pem \
            -out /tmp/ha-data/ssl/fullchain.pem

          # Copy add-ons to local addons directory
          IFS=',' read -ra ADDON_ARRAY <<< "${{ needs.filter-ingress.outputs.ingress_addons }}"
          for addon in "${ADDON_ARRAY[@]}"; do
            addon=$(echo "$addon" | xargs)  # trim whitespace
            if [ -d "./$addon" ]; then
              echo "Copying $addon to local addons..."
              cp -r "./$addon" "/tmp/ha-data/addons/local/"
            elif [ -d "./.unsupported/$addon" ]; then
              echo "Copying $addon from unsupported to local addons..."
              cp -r "./.unsupported/$addon" "/tmp/ha-data/addons/local/"
            else
              echo "Warning: Add-on $addon not found"
            fi
          done

          # Start the devcontainer with Supervisor
          docker run -d \
            --name ha-supervisor-test \
            --privileged \
            --network ha-test-net \
            -p ${{ env.HA_PORT }}:7123 \
            -v /tmp/ha-data/addons:/mnt/supervisor/addons \
            -v /tmp/ha-data/config:/mnt/supervisor/homeassistant \
            -v /tmp/ha-data/share:/mnt/supervisor/share \
            -v /tmp/ha-data/ssl:/mnt/supervisor/ssl \
            -e SUPERVISOR_SHARE_DATA=1 \
            -v ha-supervisor-storage:/var/lib/docker \
            ${{ env.DEVCONTAINER_IMAGE }} \
            sleep infinity

          echo "Container started, waiting for initialization..."
          sleep 10

          # Create missing directory for Docker
          docker exec ha-supervisor-test mkdir -p /var/lib/docker

          # Start Supervisor inside the container (detached)
          # Use 'script' to maintain TTY for stty checks while logging
          docker exec -d ha-supervisor-test script -f -q -c "supervisor_run" /tmp/supervisor.log || true

          echo "Waiting for Supervisor to be ready..."
          for i in $(seq 1 ${{ env.SUPERVISOR_STARTUP_TIMEOUT }}); do
            if docker exec ha-supervisor-test ha supervisor info >/dev/null 2>&1; then
              echo "‚úÖ Supervisor is ready after ${i}s"
              echo "supervisor_ready=true" >> "$GITHUB_OUTPUT"
              break
            fi

            # Fail fast if container crashed
            if [ "$(docker inspect -f '{{.State.Status}}' ha-supervisor-test 2>/dev/null)" != "running" ]; then
              echo "Container stopped unexpectedly!"
              break
            fi

            echo "Waiting... ($i/${{ env.SUPERVISOR_STARTUP_TIMEOUT }})"
            sleep 1
          done

          if ! grep -q supervisor_ready=true "$GITHUB_OUTPUT" 2>/dev/null; then
            echo "‚ùå Supervisor failed to start"
            echo "::group::Internal Supervisor Logs"
            docker exec ha-supervisor-test cat /tmp/supervisor.log || echo "No internal logs found"
            echo "::endgroup::"
            echo "::group::Docker Logs"
            docker logs ha-supervisor-test
            echo "::endgroup::"
            echo "supervisor_ready=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          # Dependencies
          if echo "${{ needs.filter-ingress.outputs.ingress_addons }}" | grep -qE "wiki.js|pterodactyl-panel"; then
            echo "Installing Dependency: MariaDB (core_mariadb)..."
            if ! docker exec ha-supervisor-test ha addons install core_mariadb; then
                 echo "‚ö†Ô∏è Failed to install core_mariadb"
                 echo "MYSQL_FAILED=true" >> "$GITHUB_ENV"
            elif ! docker exec ha-supervisor-test ha addons start core_mariadb; then
                 echo "‚ö†Ô∏è Failed to start core_mariadb"
                 echo "MYSQL_FAILED=true" >> "$GITHUB_ENV"
            else
                 echo "Waiting for MariaDB to be ready..."
                 echo "MYSQL_FAILED=false" >> "$GITHUB_ENV"
                 # Poll for MariaDB status
                 MAX_WAIT=60
                 START_TIME=$(date +%s)
                 READY=false
                 while [ $(($(date +%s) - START_TIME)) -lt $MAX_WAIT ]; do
                   STATUS=$(docker exec ha-supervisor-test ha addons info core_mariadb --raw-json | jq -r '.data.state' 2>/dev/null || echo "unknown")
                   if [ "$STATUS" = "started" ]; then
                     echo "‚úÖ MariaDB is started and ready."
                     READY=true
                     break
                   fi
                   echo "  ... MariaDB status: $STATUS (waiting)"
                   sleep 5
                 done
                 if [ "$READY" != "true" ]; then
                   echo "‚ö†Ô∏è MariaDB failed to reach 'started' state within ${MAX_WAIT}s"
                   echo "MYSQL_FAILED=true" >> "$GITHUB_ENV"
                 fi
            fi
          else
            echo "MYSQL_FAILED=false" >> "$GITHUB_ENV"
          fi

      - name: "üîç Test Add-ons"
        if: steps.supervisor.outputs.supervisor_ready == 'true'
        id: test
        run: |
          # shellcheck disable=SC2086,SC2129,SC2034
          RESULTS=""
          FAILED=0
          # TIMEOUT="${{ inputs.timeout || '15' }}" # Unused currently
          # TIMEOUT=15

          IFS=',' read -ra ADDON_ARRAY <<< "${{ needs.filter-ingress.outputs.ingress_addons }}"

          for addon in "${ADDON_ARRAY[@]}"; do
            addon=$(echo "$addon" | xargs)  # trim whitespace
            if [ -z "$addon" ]; then continue; fi

            if [ "$MYSQL_FAILED" = "true" ] && echo "$addon" | grep -qE "wiki\.js|wiki\.js3|pterodactyl-panel"; then
                 echo "‚è≠Ô∏è $addon dependency failed - skipping"
                 RESULTS="$RESULTS\n‚è≠Ô∏è $addon: SKIP (Dependency failed)"
                 continue
            fi

            echo ""
            echo "=========================================="
            echo "Testing: $addon"
            echo "=========================================="

            # Get exact slug from config.yaml
            CONFIG_FILE="./$addon/config.yaml"
            if [ ! -f "$CONFIG_FILE" ]; then
              CONFIG_FILE="./.unsupported/$addon/config.yaml"
            fi

            # Extract slug using grep/sed (avoids yq dependency)
            SLUG_VAL=$(grep "^slug:" "$CONFIG_FILE" | head -n 1 | cut -d':' -f2 | tr -d ' "' | xargs)
            if [ -z "$SLUG_VAL" ]; then
              SLUG_VAL="$addon"
            fi
            SLUG="local_$SLUG_VAL"
            echo "Slug detected: $SLUG"

            # Refresh add-on store
            echo "Refreshing add-on store..."
            docker exec ha-supervisor-test ha addons reload || true
            echo "Waiting for supervisor to scan add-ons..."
            sleep 10

            # Check supervisor logs for any validation errors
            echo "Checking supervisor logs for errors..."
            docker exec ha-supervisor-test ha supervisor logs 2>&1 | tail -50 | grep -iE "(error|warn|$addon|$SLUG)" || echo "No relevant errors found in logs"

            # Verify add-on is detected
            echo "Checking if add-on is detected..."
            LIST_OUTPUT=$(docker exec ha-supervisor-test ha addons --raw-json 2>&1 || echo "[]")
            if echo "$LIST_OUTPUT" | grep -q "$SLUG"; then
              echo "‚úÖ Add-on detected: $SLUG"
            else
              echo "‚ö†Ô∏è Add-on not found in list, but continuing with install attempt..."
              echo "Available add-ons:"
              echo "$LIST_OUTPUT" | jq -r '.[] | "\(.slug) - \(.name)"' 2>/dev/null || echo "$LIST_OUTPUT"
              echo ""
              echo "Checking add-on directory structure..."
              docker exec ha-supervisor-test ls -la /mnt/supervisor/addons/local/ 2>&1 || echo "Could not list add-on directory"
              echo ""
              echo "Checking if add-on files exist in container..."
              docker exec ha-supervisor-test ls -la "/mnt/supervisor/addons/local/$addon/" 2>&1 || echo "Add-on directory not found"
              echo ""
              echo "Checking for validation errors in supervisor logs..."
              docker exec ha-supervisor-test ha supervisor logs 2>&1 | tail -100 | grep -iE "(validation|error|$addon|$SLUG)" || echo "No validation errors found"
            fi

            # Install add-on
            echo "Installing $addon ($SLUG)..."
            set +e  # Don't exit on error, we'll handle it
            INSTALL_OUTPUT=$(timeout "${ADDON_INSTALL_TIMEOUT}s" docker exec ha-supervisor-test ha addons install "$SLUG" 2>&1)
            INSTALL_EXIT=$?
            set -e  # Re-enable exit on error

            # Always show output for debugging
            echo "Install command exit code: $INSTALL_EXIT"
            if [ -n "$INSTALL_OUTPUT" ]; then
              echo "Install output:"
              echo "$INSTALL_OUTPUT"
            else
              echo "‚ö†Ô∏è No output from install command"
            fi

            # Handle 500 errors as warnings instead of failures
            # Note: This is likely a CI container issue, but could also indicate real add-on start problems
            # Should be investigated if it occurs frequently
            if [ $INSTALL_EXIT -ne 0 ]; then
              if echo "$INSTALL_OUTPUT" | grep -qE "unexpected server response.*500|500.*unexpected server response|status: 500"; then
                echo "‚ö†Ô∏è Install returned 500 error (treating as WARN - likely CI container issue, but verify add-on)"
                docker exec ha-supervisor-test ha addons logs "$SLUG" 2>&1 | tail -25 || true
                
                # Verify if add-on was actually installed despite the 500 error
                echo "Verifying if add-on was actually installed..."
                ADDON_INFO=$(docker exec ha-supervisor-test ha addons info "$SLUG" --raw-json 2>&1 || echo "")
                ADDON_STATE=$(echo "$ADDON_INFO" | jq -r '.data.state // "unknown"' 2>/dev/null || echo "unknown")
                
                # Check if add-on is installed by looking for state or installed flag
                if echo "$ADDON_INFO" | grep -qE '"installed":\s*true|"state":\s*"(started|stopped|error)"' || [ "$ADDON_STATE" != "unknown" ]; then
                  echo "‚úÖ Add-on was installed despite 500 error (state: $ADDON_STATE), continuing..."
                  INSTALL_EXIT=0
                  RESULTS="$RESULTS\n‚ö†Ô∏è $addon: WARN (Install 500 error but installed - likely CI issue)"
                elif echo "$ADDON_INFO" | grep -qi "not installed\|not found"; then
                  echo "‚ùå Add-on was NOT installed despite 500 error"
                  echo "Checking supervisor logs for validation errors..."
                  docker exec ha-supervisor-test ha supervisor logs 2>&1 | tail -100 | grep -iE "(error|$addon|$SLUG|install|validation)" || echo "No relevant errors in supervisor logs"
                  RESULTS="$RESULTS\n‚ùå $addon: FAIL (Install 500 error and not installed)"
                  FAILED=1
                  INSTALL_EXIT=1
                else
                  # If we can't determine, be conservative and fail
                  echo "‚ö†Ô∏è Could not determine install status, treating as failure"
                  echo "Add-on info output: $ADDON_INFO"
                  RESULTS="$RESULTS\n‚ùå $addon: FAIL (Install 500 error, status unclear)"
                  FAILED=1
                  INSTALL_EXIT=1
                fi
              else
                echo "‚ùå Install failed with exit code $INSTALL_EXIT"
                echo "Checking supervisor logs for more details..."
                docker exec ha-supervisor-test ha supervisor logs 2>&1 | tail -100 | grep -iE "(error|$addon|$SLUG|install|validation)" || echo "No relevant errors in supervisor logs"
                echo "Checking add-on info..."
                docker exec ha-supervisor-test ha addons info "$SLUG" 2>&1 || echo "Could not get add-on info"
                docker exec ha-supervisor-test ha addons logs "$SLUG" 2>&1 | tail -50 || echo "Could not get add-on logs"
                RESULTS="$RESULTS\n‚ùå $addon: FAIL (Install failed)"
                FAILED=1
              fi
            fi

            if [ $INSTALL_EXIT -eq 0 ]; then
              echo "‚úÖ Install successful"

              # Configure options if needed (matching PowerShell logic)
              OPTS=""
              if grep -q "website_name" "$CONFIG_FILE"; then
                OPTS='{"website_name": "example.com"}'
              elif [ "$addon" = "bash_script_executer" ]; then
                OPTS='{"script_path": "/share/test.sh"}'
              fi

              if [ -n "$OPTS" ]; then
                echo "Configuring options for $SLUG..."
                # Create the update script if it doesn't exist
                # shellcheck disable=SC2016
                cat << 'EOF' > /tmp/ha-data/addons/local/update_config.sh
          #!/bin/sh
          slug="$1"
          opts="$2"
          file="/mnt/supervisor/addons.json"
          if [ ! -f "$file" ]; then exit 1; fi
          tmp=$(mktemp)
          jq --arg slug "$slug" --argjson opts "$opts" '
            if .user[$slug] == null then .user[$slug] = {} else . end |
            .user[$slug].options = $opts
          ' "$file" > "$tmp" && mv "$tmp" "$file"
          EOF
                docker exec ha-supervisor-test sh /mnt/supervisor/addons/local/update_config.sh "$SLUG" "$OPTS" || echo "‚ö†Ô∏è Failed to update options"
              fi

              # Start add-on
              echo "Starting $addon..."
              START_OUTPUT=$(timeout "${ADDON_START_TIMEOUT}s" docker exec ha-supervisor-test ha addons start "$SLUG" 2>&1)
              START_EXIT=$?

              # Handle 500 errors as warnings instead of failures
              # Note: This is likely a CI container issue, but could also indicate real add-on start problems
              # Should be investigated if it occurs frequently
              if [ $START_EXIT -ne 0 ]; then
                if echo "$START_OUTPUT" | grep -qE "unexpected server response.*500|500.*unexpected server response|status: 500"; then
                  echo "‚ö†Ô∏è Start returned 500 error (treating as WARN - likely CI container issue, but verify add-on)"
                  echo "$START_OUTPUT"
                  docker exec ha-supervisor-test ha addons logs "$SLUG" 2>&1 | tail -25 || true
                  RESULTS="$RESULTS\n‚ö†Ô∏è $addon: WARN (Start 500 error - likely CI issue)"
                  # Continue with status check even though start reported 500
                  START_EXIT=0
                else
                  echo "‚ùå Start failed"
                  echo "$START_OUTPUT"
                  docker exec ha-supervisor-test ha addons logs "$SLUG" 2>&1 | tail -50 || true
                  RESULTS="$RESULTS\n‚ùå $addon: FAIL (Start failed)"
                  FAILED=1
                fi
              fi

              if [ $START_EXIT -eq 0 ]; then
                echo "‚úÖ Start command successful"

                # Poll for status (wait for start)
                echo "Waiting for add-on to start (up to ${ADDON_START_TIMEOUT}s)..."
                START_TIME=$(date +%s)
                END_TIME=$((START_TIME + ADDON_START_TIMEOUT))
                STATUS="unknown"

                while [ "$(date +%s)" -lt "$END_TIME" ]; do
                  # Check if container is running (more reliable than CLI)
                  if docker exec ha-supervisor-test docker ps --format "{{.Names}}" | grep -q "addon_local_$SLUG_VAL"; then
                    STATUS="started"
                    break
                  fi
                  # Fallback to CLI check
                  STATUS="$(docker exec ha-supervisor-test ha addons info "$SLUG" --raw-json 2>/dev/null | jq -r '.data.state // "unknown"')"
                  if [ "$STATUS" = "started" ]; then
                    break
                  fi
                  echo -n "."
                  sleep 5
                done
                echo ""
                echo "Final Add-on state: $STATUS"

                if [ "$STATUS" = "started" ]; then
                  # Test ingress
                  echo "Testing ingress endpoint..."
                  INGRESS_URL="$(docker exec ha-supervisor-test ha addons info "$SLUG" --raw-json 2>/dev/null | jq -r '.data.ingress_url // ""')"
                  if [ -n "$INGRESS_URL" ]; then
                    HTTP_CODE="$(docker exec ha-supervisor-test curl -s -o /dev/null -w "%{http_code}" "http://localhost:8099$INGRESS_URL" 2>&1 || echo "000")"
                    if echo "$HTTP_CODE" | grep -q "^[23]"; then
                      echo "‚úÖ Ingress reachable (HTTP $HTTP_CODE)"
                      RESULTS="$RESULTS\n‚úÖ $addon: PASS (Ingress OK)"
                    else
                      echo "‚ö†Ô∏è Ingress returned HTTP $HTTP_CODE"
                      RESULTS="$RESULTS\n‚ö†Ô∏è $addon: WARN (Ingress HTTP $HTTP_CODE)"
                    fi
                  else
                    RESULTS="$RESULTS\n‚úÖ $addon: PASS (Running, no ingress URL)"
                  fi
                else
                  echo "‚ùå Add-on not in 'started' state"
                  docker exec ha-supervisor-test ha addons logs "$SLUG" 2>&1 | tail -50
                  RESULTS="$RESULTS\n‚ùå $addon: FAIL (State: $STATUS)"
                  FAILED=1
                fi
              fi

              # Stop and uninstall
              echo "Cleaning up $addon..."
              docker exec ha-supervisor-test ha addons stop "$SLUG" 2>/dev/null || true
              docker exec ha-supervisor-test ha addons uninstall "$SLUG" 2>/dev/null || true
            fi
          done

          echo ""
          echo "=========================================="
          echo "SUMMARY"
          echo "=========================================="
          echo -e "$RESULTS"

          echo "failed=$FAILED" >> "$GITHUB_OUTPUT"

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi

      - name: "üßπ Cleanup"
        if: always()
        run: |
          echo "Stopping and removing containers..."
          docker stop ha-supervisor-test 2>/dev/null || true
          docker rm -f ha-supervisor-test 2>/dev/null || true
          docker network rm ha-test-net 2>/dev/null || true
          sudo rm -rf /tmp/ha-data

      - name: "üìä Summary"
        if: always()
        run: |
          {
            echo "## üß™ Supervisor Integration Test Results"
            echo ""
            echo "**Add-ons tested:** ${{ needs.filter-ingress.outputs.ingress_addons }}"
            echo ""
            if [ "${{ steps.test.outputs.failed }}" = "1" ]; then
              echo "‚ùå **Some tests failed**"
            else
              echo "‚úÖ **All tests passed**"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
