#!/command/with-contenv bashio

# Wait for PostgreSQL to be ready
bashio::log.info "Waiting for PostgreSQL to be ready..."
until pg_isready -h localhost -U postgres; do
    sleep 1
done

# Generate password if not exists
if ! bashio::fs.file_exists "/data/ttrss_db_password"; then
    openssl rand -base64 32 > /data/ttrss_db_password
fi
TTRSS_DB_PASSWORD=$(cat /data/ttrss_db_password)

# Create TT-RSS database and user if they don't exist
bashio::log.info "Ensuring TT-RSS database and user exist..."
psql -h localhost -U postgres -tc "SELECT 1 FROM pg_database WHERE datname = 'ttrss'" | grep -q 1 || \
    psql -h localhost -U postgres -c "CREATE DATABASE ttrss;"

psql -h localhost -U postgres -tc "SELECT 1 FROM pg_roles WHERE rolname = 'ttrss'" | grep -q 1 || \
    psql -h localhost -U postgres -c "CREATE USER ttrss WITH PASSWORD '${TTRSS_DB_PASSWORD}';"

psql -h localhost -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE ttrss TO ttrss;"

# Note: TT-RSS schema initialization is usually handled by the app or an install script.
# We might need to run php /var/www/tt-rss/update.php --update-schema if it's CLI based,
# or let the web installer handle it. The 'tt-rss-updater' service typically handles schema updates.
# But for first run, we usually want it ready.
# TT-RSS documentation suggests accessing the web UI for installer or using CLI `php ./update.php --update-schema`.
# We will attempt CLI schema update here if valid.

# Actually, TT-RSS docker containers often use `php ./update.php --update-schema` on boot.
bashio::log.info "Checking/Updating TT-RSS schema..."
cd /var/www/tt-rss

# We need to configure config.php first? Or pass params?
# TT-RSS looks for config.php. If we haven't generated it, we can't update schema.
# The `init-tt-rss` (which this script can supplement or replace) usually handles config.

# Ideally `init-tt-rss` creates config.php from templates/envs.
# Let's ensure `init-tt-rss` runs BEFORE or AFTER this?
# This `init-ttrss-db` creates the DB. `init-tt-rss` creates config.
# If `init-tt-rss` needs DB connection details, it needs to know them.
# We should probably combine or ensure order.
# Let's assume `init-tt-rss` will generate config.php using the same passwords.
