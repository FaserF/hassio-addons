#!/command/with-contenv bashio
# shellcheck shell=bash

bashio::log.info "Initializing PostgreSQL..."

# Create runtime directory for PostgreSQL lock files
mkdir -p /run/postgresql
chown postgres:postgres /run/postgresql

if [ ! -d "/data/database" ] || [ -z "$(ls -A "/data/database")" ]; then
    bashio::log.info "Creating new database cluster in /data/database..."
    mkdir -p /data/database
    chown -R postgres:postgres /data/database
    chmod 700 /data/database

    echo "${POSTGRES_PASSWORD}" > /tmp/pgpass
    chown postgres:postgres /tmp/pgpass

    if ! su-exec postgres initdb -D /data/database --username=postgres --auth=md5 --pwfile=/tmp/pgpass 2>&1; then
        bashio::log.error "initdb failed! Command: su-exec postgres initdb -D /data/database --username=postgres --auth=md5 --pwfile=/tmp/pgpass"
        rm -f /tmp/pgpass
        exit 1
    fi

    rm -f /tmp/pgpass
else
    bashio::log.info "Database cluster exists in /data/database."
    # Ensure permissions are correct even if it exists
    chown -R postgres:postgres /data/database
    chmod 700 /data/database
fi
