#!/command/with-contenv bashio
# shellcheck shell=bash
set -e

bashio::log.info "Initializing Backend..."

# Wait for PostgreSQL to be ready
if ! bashio::net.wait_for 5432 localhost 30; then
    bashio::log.error "PostgreSQL not available on port 5432 after 30s timeout"
    exit 1
fi

# Validate POSTGRES_PASSWORD is set (from init-secrets)
if ! bashio::var.has_value "${POSTGRES_PASSWORD}" && [ ! -f /var/run/s6/container_environment/POSTGRES_PASSWORD ]; then
    bashio::log.error "POSTGRES_PASSWORD environment variable is not set. init-secrets might have failed."
    exit 1
fi

# Navigate to app directory
if ! cd /app; then
    bashio::log.error "Failed to change directory to /app"
    exit 1
fi

# ------------------------------------------------------------------------------
# PERSISTENCE SETUP
# ------------------------------------------------------------------------------
bashio::log.info "Ensuring persistence for data and uploads..."

# 1. persist: /app/data (Database/Settings)
if [ ! -d "/data/er_dashboard/app_data" ]; then
    bashio::log.info "Creating persistent storage for app data..."
    mkdir -p /data/er_dashboard/app_data
    # If the container has default data, copy it to persistence (migration)
    if [ -d "/app/data" ] && [ "$(ls -A /app/data)" ]; then
         bashio::log.info "Migrating existing default data to persistent storage..."
         cp -r /app/data/* /data/er_dashboard/app_data/
    fi
fi

# Relink /app/data -> /data/er_dashboard/app_data
if [ -d "/app/data" ] && [ ! -L "/app/data" ]; then
    rm -rf /app/data
fi
if [ ! -L "/app/data" ]; then
    ln -s /data/er_dashboard/app_data /app/data
    bashio::log.info "Linked /app/data to /data/er_dashboard/app_data"
fi


# 2. persist: /app/uploads (Logos/Images)
if [ ! -d "/data/er_dashboard/uploads" ]; then
    bashio::log.info "Creating persistent storage for uploads..."
    mkdir -p /data/er_dashboard/uploads
    # If the container has default uploads, copy it (migration)
    if [ -d "/app/uploads" ] && [ "$(ls -A /app/uploads)" ]; then
         bashio::log.info "Migrating existing default uploads to persistent storage..."
         cp -r /app/uploads/* /data/er_dashboard/uploads/
    fi
fi

# Relink /app/uploads -> /data/er_dashboard/uploads
if [ -d "/app/uploads" ] && [ ! -L "/app/uploads" ]; then
    rm -rf /app/uploads
fi
if [ ! -L "/app/uploads" ]; then
    ln -s /data/er_dashboard/uploads /app/uploads
    bashio::log.info "Linked /app/uploads to /data/er_dashboard/uploads"
fi
# ------------------------------------------------------------------------------

# Run migrations if necessary (currently just logging)
# su-exec postgres /app/.venv/bin/alembic upgrade head

bashio::log.info "Backend initialization complete."
